<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | LINAC QA</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles */
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: linear-gradient(to bottom right, #dbeafe, #f0f9ff);
            color: #333;
        }
        .admin-header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            font-size: 2em;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .admin-header h1 {
            margin: 0;
            font-size: 1.2em; /* Smaller for header */
            flex-grow: 1; /* Allows it to take available space */
            text-align: center;
        }
        .logout-button {
            padding: 5px 10px; /* Even smaller padding */
            font-size: 0.8em; /* Even smaller font size */
            background-color: #dc3545; /* Red for logout */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            white-space: nowrap; /* Prevent button text from wrapping */
        }
        .logout-button:hover {
            background-color: #c82333;
        }

        /* NEW: Main layout for sidebar */
        .main-admin-layout {
            display: flex;
            flex-grow: 1; /* Allows this to take remaining vertical space */
            width: 100%; /* Ensure this takes 100% of the body's available width */
            max-width: unset; /* Remove max-width to allow it to span full width */
            margin: 0; /* Remove auto margin to allow it to stick to left */
            box-sizing: border-box; /* Ensure padding/border don't cause overflow */
        }

        .sidebar-nav {
            width: 200px; /* Adjusted: Width for the sidebar */
            background-color: #ffffff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.08);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex-shrink: 0; /* Prevent sidebar from shrinking */
            box-sizing: border-box;
            /* It will naturally stick to the left because .main-admin-layout is display: flex and margin is 0 */
        }

        .sidebar-nav .nav-btn {
            width: 100%;
            padding: 15px 10px;
            border: none;
            background-color: #eee;
            color: #333;
            font-size: 1em;
            font-weight: 600;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar-nav .nav-btn:hover:not(.active) {
            background-color: #e0e0e0;
        }

        .sidebar-nav .nav-btn.active {
            background-color: #007bff;
            color: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .content-display-area {
            flex-grow: 1; /* Allows content area to take remaining space */
            padding: 20px;
            display: flex; /* Use flexbox to manage child card-sections */
            flex-direction: column;
            gap: 30px; /* Space between sections if multiple are visible */
            overflow-y: auto; /* Allows content area to scroll vertically */
            box-sizing: border-box;
        }

        /* Adjust existing card-section to fit into content-display-area */
        .card-section { /* Old selector, make sure it applies */
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 100%; /* Take full width of content-display-area */
            max-width: unset; /* Remove max-width from here as content-display-area controls it */
            margin: 0; /* Remove auto margins as flexbox manages */
            box-sizing: border-box;
            display: none; /* Hide all card sections by default in normal flow */
        }
        .card-section.active-section {
            display: block; /* Show only the active one */
        }
        /* Override specific card-section h2 as it's now wrapped in a general h2 */
        .card-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }


        .admin-footer {
            margin-top: auto;
            padding: 15px;
            font-size: 12px;
            color: #6b7280;
            background-color: #f8f8f8;
            border-top: 1px solid #ccc;
            text-align: center;
            flex-shrink: 0;
        }

        /* Filter and Search */
        .filter-search-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .filter-search-container input[type="text"],
        .filter-search-container select {
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.95em;
            flex: 1;
            min-width: 150px;
        }
        .filter-search-container button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.95em;
        }
        .filter-search-container button:hover {
            background-color: #0056b3;
        }

        /* User List Table */
        .user-table-container {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto; /* NEW: Allow horizontal scroll for user table */
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .user-table {
            width: 100%; /* Will try to fit 100% of container */
            border-collapse: collapse;
            table-layout: auto; /* CRITICAL CHANGE: Allow browser to auto-size columns based on content */
        }
        .user-table th, .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: normal; /* Allow normal wrapping for data cells */
            word-wrap: break-word; /* Ensure long words break */
            overflow: visible; /* Ensure content is not hidden by default */
        }
        .user-table th {
            background-color: #e0f7fa;
            color: #007bff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        /* Define min-widths for user table columns (percentages removed, auto layout) */
        .user-table th:nth-child(1), .user-table td:nth-child(1) { min-width: 100px; } /* Name */
        .user-table th:nth-child(2), .user-table td:nth-child(2) { min-width: 150px; } /* Email */
        .user-table th:nth-child(3), .user-table td:nth-child(3) { min-width: 110px; } /* Hospital */
        .user-table th:nth-child(4), .user-table td:nth-child(4) { min-width: 90px; } /* Role */
        .user-table th:nth-child(5), .user-table td:nth-child(5) { min-width: 70px; } /* Status */
        .user-table th:nth-child(6), .user-table td:nth-child(6) { min-width: 190px; } /* Actions - SIGNIFICANTLY INCREASED to ensure all 3 buttons fit */


        .user-table .user-actions button {
            padding: 5px 8px;
            font-size: 0.8em;
            border-radius: 4px;
            margin-left: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .user-table .approve-btn { background-color: #28a745; color: white; }
        .user-table .approve-btn:hover { background-color: #218838; }
        .user-table .reject-btn { background-color: #ffc107; color: #333; }
        .user-table .reject-btn:hover { background-color: #e0a800; }
        .user-table .edit-btn { background-color: #17a2b8; color: white; }
        .user-table .edit-btn:hover { background-color: #138496; }
        /* NEW: Delete button styles */
        .user-table .delete-btn {
            background-color: #6c757d; /* A neutral gray for delete */
            color: white;
        }
        .user-table .delete-btn:hover {
            background-color: #5a6268;
        }

        /* Styles for actions column to allow buttons to display side-by-side */
        .user-table td:nth-child(6) {
            white-space: nowrap; /* Keep the buttons on one line */
            overflow: hidden; /* Hide if buttons still overflow min-width */
            text-overflow: ellipsis; /* Show ellipsis if content overflows */
            display: flex; /* Use flexbox for button layout */
            flex-wrap: nowrap; /* Ensure buttons stay on one line */
            gap: 5px; /* Space between buttons */
            justify-content: center; /* Center buttons horizontally */
            align-items: center; /* Center buttons vertically */
        }
        .user-table td:nth-child(6) button {
            margin: 0 !important; /* Override individual button margins */
            flex-shrink: 0; /* Prevent buttons from shrinking if space is tight */
        }


        .no-users-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        /* Loading Overlay & Spinner (re-used from upload.html) */
        #loading-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 8px solid #ffffff;
            border-top-color: #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modal Styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 10000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }
        .modal h3 {
            color: #007bff;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
        }
        .modal label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        .modal input[type="text"],
        .modal select {
            width: calc(100% - 22px); /* Account for padding and border */
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
        }
        .modal-buttons {
            text-align: center;
            margin-top: 20px;
        }
        .modal-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .modal-buttons .save-btn {
            background-color: #28a745;
            color: white;
        }
        .modal-buttons .save-btn:hover {
            background-color: #218838;
        }
        .modal-buttons .cancel-btn {
            background-color: #6c757d;
            color: white;
        }
        .modal-buttons .cancel-btn:hover {
            background-color: #5a6268;
        }
        #modalErrorMsg {
            color: red;
            text-align: center;
            margin-bottom: 10px;
        }

        /* Specific styles for data cells */
        .user-table td.within, .hospital-qa-table td.within { background-color: #d4edda !important; color: #155724 !important; }
        .user-table td.warning, .hospital-qa-table td.warning { background-color: #fff3cd !important; color: #856404 !important; }
        .user-table td.out, .hospital-qa-table td.out { background-color: #f8d7da !important; color: #721c24 !important; }

        /* New CSS for Fullscreen Button */
        .fullscreen-btn {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #007bff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s ease, transform 0.2s ease;
        }
        .fullscreen-btn:hover {
            color: #0056b3;
            transform: translateY(-50%) scale(1.1);
        }
        .fullscreen-btn i {
            pointer-events: none; /* Prevents icon from blocking button click */
        }
        
        /* CSS for Fullscreen Mode */
        #hospital-data-access-section:-webkit-full-screen,
        #hospital-data-access-section:-moz-full-screen,
        #hospital-data-access-section:-ms-fullscreen,
        #hospital-data-access-section:fullscreen {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 20px;
            z-index: 9999999;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            box-sizing: border-box;
        }

        #hospital-data-access-section:fullscreen .user-table-container {
            flex-grow: 1;
            max-height: unset;
            width: 100%;
            overflow: auto;
        }

        /* New/Modified CSS for Hospital QA Table */
        .hospital-qa-table {
            width: max-content;
            min-width: 100%;
            border-collapse: collapse;
            border: 1px solid #999;
        }

        .hospital-qa-table th, .hospital-qa-table td {
            padding: 5px;
            text-align: center;
            border: 1px solid #999;
            white-space: nowrap;
        }

        .hospital-qa-table th:first-child,
        .hospital-qa-table td:first-child {
            width: 100px;
            min-width: 100px;
            text-align: left;
            white-space: normal;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <h1>LINAC QA Admin Portal</h1>
        <button onclick="logout()" class="logout-button">Logout</button>
    </div>

    <div class="main-admin-layout">
        <div class="sidebar-nav">
            <button id="manageUsersBtn" class="nav-btn active" onclick="showAdminSection('manage-users-section')">
                MANAGE USER ACCOUNTS
            </button>
            <button id="viewHospitalDataBtn" class="nav-btn" onclick="showAdminSection('hospital-data-access-section')">
                VIEW HOSPITAL DATA
            </button>
        </div>

        <div class="content-display-area">
            <div class="card-section active-section" id="manage-users-section">
                <h2>Manage User Accounts</h2>
                <div class="filter-search-container">
                    <input type="text" id="searchUserInput" placeholder="Search by name, email, hospital..." onkeyup="filterUsers()">
                    <select id="filterStatus" onchange="filterUsers()">
                        <option value="">All Statuses</option>
                        <option value="pending">Pending</option>
                        <option value="active">Active</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <select id="filterRole" onchange="filterUsers()">
                        <option value="">All Roles</option>
                        <option value="Medical physicist">Medical physicist</option>
                        <option value="RSO">RSO</option>
                        <option value="Admin">Admin</option>
                    </select>
                    <select id="filterHospital" onchange="filterUsers()">
                        <option value="">All Hospitals</option>
                        </select>
                    <button onclick="loadAllUsers()">Refresh</button>
                </div>
                <div class="user-table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Hospital</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="6" class="no-users-message">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-section" id="hospital-data-access-section">
                <h2 style="position: relative;">
                    View Hospital LINAC QA Data
                    <button id="fullscreenHospitalDataBtn" class="fullscreen-btn" onclick="toggleFullscreenHospitalData()">
                        <i class="fas fa-expand"></i>
                    </button>
                </h2>
                <div class="filter-search-container" id="hospitalDataControls">
                    <select id="adminHospitalSelect">
                        <option value="">Select Hospital</option>
                        </select>
                    <select id="adminYearSelect">
                        </select>
                    <select id="adminMonthSelect">
                        </select>
                    <button onclick="loadHospitalQaData()">Load Data</button>
                </div>
                <div class="user-table-container">
                    <table class="user-table hospital-qa-table">
                        <thead>
                            <tr id="hospitalQaTableHeader">
                                <th>Energy</th>
                                </tr>
                        </thead>
                        <tbody id="hospitalQaDataTableBody">
                            <tr><td colspan="32" class="no-users-message" style="text-align:center;">Select a hospital, year, and month, then click Load Data.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="admin-footer">
        © 2025 LINAC QA System - Admin Access
    </div>

    <div id="loading-overlay"><div class="spinner"></div></div>

    <div id="userEditModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h3>Edit User Details</h3>
            <div id="modalErrorMsg"></div>
            <input type="hidden" id="editUserId">
            <label for="editUserName">Name:</label>
            <input type="text" id="editUserName" readonly>

            <label for="editUserEmail">Email:</label>
            <input type="text" id="editUserEmail" readonly>

            <label for="editUserHospital">Hospital:</label>
            <select id="editUserHospital">
                </select>

            <label for="editUserRole">Role:</label>
            <select id="editUserRole">
                <option value="Medical physicist">Medical physicist</option>
                <option value="RSO">RSO</option>
                <option value="Admin">Admin</option>
            </select>

            <label for="editUserStatus">Status:</label>
            <select id="editUserStatus">
                <option value="pending">Pending</option>
                <option value="active">Active</option>
                <option value="rejected">Rejected</option>
            </select>

            <div class="modal-buttons">
                <button class="save-btn" onclick="saveUserChanges()">Save Changes</button>
                <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Initialization ---
        const firebaseConfig = {
          apiKey: "AIzaSyBtG_xKqhJZFXmEvJ-Y0uqTG3WurrDSRgE",
          authDomain: "linac-qa-project.firebaseapp.com",
          projectId: "linac-qa-project",
          storageBucket: "linac-qa-project.firebasestorage.app",
          messagingSenderId: "850988733382",
          appId: "1:850988733382:web:ef75d64e30deb7e37c18c7",
          measurementId: "G-HFJ2CGS664"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- UPDATED: Central Backend URL ---
        // IMPORTANT: Confirm this URL matches your deployed backend service on Render.com
        const BACKEND_URL = 'https://backend-results.onrender.com';

        let allUsersData = [];
        let lastLoadedHospitalQaData = { data: [], year: null, month: null };

        // DOM elements
        const loadingOverlay = document.getElementById('loading-overlay');
        const usersTableBody = document.getElementById('usersTableBody');
        const searchUserInput = document.getElementById('searchUserInput');
        const filterStatus = document.getElementById('filterStatus');
        const filterRole = document.getElementById('filterRole');
        const filterHospital = document.getElementById('filterHospital');
        const userEditModal = document.getElementById('userEditModal');
        const editUserId = document.getElementById('editUserId');
        const editUserName = document.getElementById('editUserName');
        const editUserEmail = document.getElementById('editUserEmail');
        const editUserHospital = document.getElementById('editUserHospital');
        const editUserRole = document.getElementById('editUserRole');
        const editUserStatus = document.getElementById('editUserStatus');
        const modalErrorMsg = document.getElementById('modalErrorMsg');
        const manageUsersBtn = document.getElementById('manageUsersBtn');
        const viewHospitalDataBtn = document.getElementById('viewHospitalDataBtn');
        const manageUsersSection = document.getElementById('manage-users-section');
        const hospitalDataAccessSection = document.getElementById('hospital-data-access-section');
        const fullscreenHospitalDataBtn = document.getElementById('fullscreenHospitalDataBtn');
        const adminHospitalSelect = document.getElementById('adminHospitalSelect');
        const adminYearSelect = document.getElementById('adminYearSelect');
        const adminMonthSelect = document.getElementById('adminMonthSelect');
        const hospitalQaTableHeader = document.getElementById('hospitalQaTableHeader');
        const hospitalQaDataTableBody = document.getElementById('hospitalQaDataTableBody');

        // --- GLOBAL HELPER FUNCTIONS ---
        function showLoader(){loadingOverlay.style.display='flex';}
        function hideLoader(){loadingOverlay.style.display='none';}

        function logout() {
            auth.signOut().then(() => {
                localStorage.clear();
                window.location.href = "login.html";
            });
        }

        // --- Admin Section Navigation ---
        async function showAdminSection(sectionId) {
            document.querySelectorAll('.sidebar-nav .nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.content-display-area .card-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active-section');
            });

            const selectedButton = document.getElementById(sectionId === 'manage-users-section' ? 'manageUsersBtn' : 'viewHospitalDataBtn');
            const selectedSection = document.getElementById(sectionId);
            
            selectedButton.classList.add('active');
            selectedSection.style.display = 'block';
            selectedSection.classList.add('active-section');

            if (sectionId === 'manage-users-section' && allUsersData.length === 0) {
                await loadAllUsers();
            } else if (sectionId === 'hospital-data-access-section' && adminHospitalSelect.options.length <= 1) {
                if (allUsersData.length === 0) await loadAllUsers();
                populateHospitalDataFilters();
            }
        }

        // --- USER MANAGEMENT FUNCTIONS ---
        async function loadAllUsers() {
            showLoader();
            usersTableBody.innerHTML = '<tr><td colspan="6" class="no-users-message">Loading users...</td></tr>';
            
            try {
                const idToken = await auth.currentUser.getIdToken(true);
                const response = await fetch(`${BACKEND_URL}/admin/users`, { // UPDATED URL
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                if (!response.ok) throw new Error((await response.json()).message || 'Failed to fetch users');
                
                allUsersData = await response.json();
                populateMainUserFilters();
                renderUsers(allUsersData);
                
            } catch (error) {
                usersTableBody.innerHTML = `<tr><td colspan="6" class="no-users-message" style="color: red;">Error: ${error.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        }

        function populateMainUserFilters() {
            const hospitals = [...new Set(allUsersData.map(user => user.hospital).filter(Boolean))];
            filterHospital.innerHTML = '<option value="">All Hospitals</option>';
            hospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital;
                option.textContent = hospital;
                filterHospital.appendChild(option);
            });
        }

        function renderUsers(usersToRender) {
            usersTableBody.innerHTML = '';
            if (usersToRender.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="6" class="no-users-message">No users found.</td></tr>';
                return;
            }
            usersToRender.forEach(user => {
                const row = usersTableBody.insertRow();
                row.innerHTML = `
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.hospital || 'N/A'}</td>
                    <td>${user.role || 'N/A'}</td>
                    <td><span style="color: ${user.status === 'active' ? 'green' : user.status === 'pending' ? 'orange' : 'red'}; font-weight: bold;">${(user.status || 'N/A').toUpperCase()}</span></td>
                    <td>
                        <button class="approve-btn" onclick="updateUserStatus('${user.uid}', 'active')">Approve</button>
                        <button class="reject-btn" onclick="updateUserStatus('${user.uid}', 'rejected')">Reject</button>
                        <button class="edit-btn" onclick="openEditModal('${user.uid}')">Edit</button>
                        <button class="delete-btn" onclick="deleteUser('${user.uid}', '${user.name || 'N/A'}', '${user.email || 'N/A'}')"><i class="fas fa-trash"></i> Delete</button>
                    </td>
                `;
            });
        }

        function filterUsers() {
            const searchTerm = searchUserInput.value.toLowerCase();
            const status = filterStatus.value;
            const role = filterRole.value;
            const hospital = filterHospital.value;
            const filtered = allUsersData.filter(user => 
                (user.name?.toLowerCase().includes(searchTerm) || user.email?.toLowerCase().includes(searchTerm) || user.hospital?.toLowerCase().includes(searchTerm)) &&
                (status === "" || user.status === status) &&
                (role === "" || user.role === role) &&
                (hospital === "" || user.hospital === hospital)
            );
            renderUsers(filtered);
        }

        async function updateUserStatus(uid, newStatus) {
            if (!confirm(`Are you sure you want to set status to ${newStatus.toUpperCase()}?`)) return;
            await saveUserChanges({ uid, status: newStatus });
        }
        
        async function deleteUser(uid, userName, userEmail) {
            if (!confirm(`WARNING: Permanently delete user ${userName} (${userEmail})? This cannot be undone.`)) return;

            showLoader();
            try {
                const idToken = await auth.currentUser.getIdToken(true);
                const response = await fetch(`${BACKEND_URL}/admin/delete-user`, { // UPDATED URL
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                    body: JSON.stringify({ uid })
                });
                if (!response.ok) throw new Error((await response.json()).message || 'Failed to delete user');
                alert('User deleted successfully!');
                await loadAllUsers();
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                hideLoader();
            }
        }

        // --- MODAL FUNCTIONS ---
        function openEditModal(uid) {
            modalErrorMsg.textContent = '';
            const user = allUsersData.find(u => u.uid === uid);
            if (!user) { alert("Error: User not found."); return; }

            editUserId.value = user.uid;
            editUserName.value = user.name || '';
            editUserEmail.value = user.email || '';
            
            const allHospitals = [...new Set(allUsersData.map(u => u.hospital).filter(Boolean))];
            editUserHospital.innerHTML = '';
            allHospitals.forEach(h => editUserHospital.add(new Option(h, h)));
            editUserHospital.add(new Option("Other / New Hospital", "Other"));
            
            editUserHospital.value = user.hospital && allHospitals.includes(user.hospital) ? user.hospital : "Other";
            
            // Handle the "Other" input field creation
            handleOtherHospitalInput(editUserHospital.value === "Other", user.hospital);

            editUserRole.value = user.role || '';
            editUserStatus.value = user.status || '';
            userEditModal.style.display = 'flex';
        }

        editUserHospital.onchange = function() {
            handleOtherHospitalInput(this.value === "Other");
        };

        function handleOtherHospitalInput(isOtherSelected, initialValue = '') {
            const existingInput = document.getElementById('newHospitalNameInput');
            if (existingInput) existingInput.remove();
            
            if (isOtherSelected) {
                const newHospitalInput = document.createElement('input');
                newHospitalInput.type = 'text';
                newHospitalInput.id = 'newHospitalNameInput';
                newHospitalInput.placeholder = 'Enter new hospital name';
                newHospitalInput.value = initialValue;
                editUserHospital.parentNode.insertBefore(newHospitalInput, editUserHospital.nextSibling);
            }
        }

        function closeEditModal() {
            userEditModal.style.display = 'none';
            const existingInput = document.getElementById('newHospitalNameInput');
            if (existingInput) existingInput.remove();
        }

        async function saveUserChanges(directData = null) {
            let changes;
            if (directData) {
                changes = directData;
            } else {
                modalErrorMsg.textContent = '';
                let hospitalToSave = editUserHospital.value;
                if (hospitalToSave === "Other") {
                    const newHospitalInput = document.getElementById('newHospitalNameInput');
                    if (newHospitalInput && newHospitalInput.value.trim()) {
                        hospitalToSave = newHospitalInput.value.trim();
                    } else {
                        modalErrorMsg.textContent = "Please enter a hospital name.";
                        return;
                    }
                }
                changes = {
                    uid: editUserId.value,
                    hospital: hospitalToSave,
                    role: editUserRole.value,
                    status: editUserStatus.value
                };
            }

            showLoader();
            try {
                const idToken = await auth.currentUser.getIdToken(true);
                const response = await fetch(`${BACKEND_URL}/admin/update-user-status`, { // UPDATED URL
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${idToken}` },
                    body: JSON.stringify(changes)
                });
                if (!response.ok) throw new Error((await response.json()).message || 'Failed to update user');
                
                alert('User details updated successfully!');
                if (!directData) closeEditModal();
                await loadAllUsers();
            } catch (error) {
                if (directData) alert(`Error: ${error.message}`);
                else modalErrorMsg.textContent = `Error: ${error.message}`;
            } finally {
                hideLoader();
            }
        }

        // --- HOSPITAL QA DATA FUNCTIONS ---
        function populateHospitalDataFilters() {
            const uniqueHospitals = [...new Set(allUsersData.map(user => user.hospital).filter(Boolean))];
            adminHospitalSelect.innerHTML = '<option value="">Select Hospital</option>';
            uniqueHospitals.forEach(h => adminHospitalSelect.add(new Option(h, h)));
            
            const currentYear = new Date().getFullYear();
            adminYearSelect.innerHTML = '';
            for (let i = currentYear; i >= currentYear - 5; i--) adminYearSelect.add(new Option(i, i));
            
            const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            adminMonthSelect.innerHTML = '';
            months.forEach((m, i) => adminMonthSelect.add(new Option(m, String(i+1).padStart(2,'0'))));
            adminMonthSelect.value = String(new Date().getMonth() + 1).padStart(2, '0');
        }

        async function loadHospitalQaData() {
            const hospitalId = adminHospitalSelect.value;
            const year = adminYearSelect.value;
            const month = adminMonthSelect.value;
            if (!hospitalId || !year || !month) { alert("Please select a hospital, year, and month."); return; }

            showLoader();
            const monthParam = `${year}-${month}`;
            hospitalQaDataTableBody.innerHTML = `<tr><td colspan="32" class="no-users-message">Loading data...</td></tr>`;
            
            try {
                const idToken = await auth.currentUser.getIdToken(true);
                const response = await fetch(`${BACKEND_URL}/admin/hospital-data?hospitalId=${hospitalId}&month=${monthParam}`, { // UPDATED URL
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (response.status === 404) {
                    lastLoadedHospitalQaData = { data: [], year, month };
                    renderHospitalQaDataTable([], year, month);
                    return;
                }
                if (!response.ok) throw new Error((await response.json()).message || 'Failed to fetch hospital data');

                const result = await response.json();
                lastLoadedHospitalQaData = { data: result.data, year, month };
                renderHospitalQaDataTable(result.data, year, month);
                
            } catch (error) {
                hospitalQaDataTableBody.innerHTML = `<tr><td colspan="32" class="no-users-message" style="color: red;">Error: ${error.message}</td></tr>`;
            } finally {
                hideLoader();
            }
        }

        function renderHospitalQaDataTable(data, year, month) {
            const numDays = new Date(year, month, 0).getDate();
            hospitalQaTableHeader.innerHTML = '<th>Energy</th>';
            for (let i = 1; i <= numDays; i++) {
                const th = document.createElement('th');
                th.textContent = `${year}-${month}-${String(i).padStart(2,'0')}`;
                hospitalQaTableHeader.appendChild(th);
            }

            hospitalQaDataTableBody.innerHTML = '';
            if (!data || data.length === 0) {
                hospitalQaDataTableBody.innerHTML = `<tr><td colspan="${numDays + 1}" class="no-users-message">No QA data found for this period.</td></tr>`;
                return;
            }

            const ENERGY_TYPES_ORDER = ["6X","10X","15X","6X FFF","10X FFF","6E","9E","12E","15E","18E"];
            const dataMap = new Map(data.map(row => [row[0], row.slice(1)]));

            ENERGY_TYPES_ORDER.forEach(energyType => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${energyType}</td>`;
                const values = dataMap.get(energyType) || Array(numDays).fill('');
                
                for (let i = 0; i < numDays; i++) {
                    const value = values[i] ?? '';
                    const n = parseFloat(value);
                    let className = '';
                    if (!isNaN(n)) {
                        if (Math.abs(n) <= 1.8) className = 'within';
                        else if (Math.abs(n) <= 2) className = 'warning';
                        else className = 'out';
                    }
                    tr.innerHTML += `<td class="${className}">${value}</td>`;
                }
                hospitalQaDataTableBody.appendChild(tr);
            });
        }

        // --- Fullscreen Toggle ---
        function toggleFullscreenHospitalData() {
            const elem = hospitalDataAccessSection;
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(err => alert(`Error attempting to enable full-screen mode: ${err.message}`));
            } else {
                document.exitFullscreen();
            }
        }
        
        document.addEventListener('fullscreenchange', () => {
            const icon = fullscreenHospitalDataBtn.querySelector('i');
            if (document.fullscreenElement) {
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
            } else {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }
            if (lastLoadedHospitalQaData.data.length) {
                renderHospitalQaDataTable(lastLoadedHospitalQaData.data, lastLoadedHospitalQaData.year, lastLoadedHospitalQaData.month);
            }
        });

        // --- Initial Load ---
        auth.onAuthStateChanged(async user => {
            if (user) {
                if (localStorage.getItem("userRole") === "Admin" && localStorage.getItem("userStatus") === "active") {
                    await showAdminSection('manage-users-section');
                } else {
                    alert("Access Denied.");
                    logout();
                }
            } else {
                window.location.href = "login.html";
            }
        });
    </script>
</body>
</html>
