<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINAC Output Entry</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* CSS Variables for Colors */
    :root {
      --primary-blue: #007bff;
      --primary-blue-dark: #0056b3;
      --primary-blue-light: #e0f7fa;
      --text-dark: #333;
      --text-light: #fff;
      --background-light: #f5f5f5;
      --background-white-card: #ffffff;
      --background-dark-card: #333;
      --background-off-white: #f8f8f8;
      --border-light: #ccc;
      --border-darker: #aaa;
      --success-green: #28a745;
      --warning-orange: #ffc107;
      --error-red: #dc3545;
      --shadow-light: rgba(0,0,0,0.08);
      --shadow-medium: rgba(0,0,0,0.12);
      --shadow-strong: rgba(0,0,0,0.2);
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--background-light);
      color: var(--text-dark);
      display: flex;
      height: 100vh;
      overflow: hidden;
      flex-direction: column;
    }

    /* Global Micro-interaction */
    button, a.button, select {
      transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    button:hover, a.button:hover, select:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px var(--shadow-light);
    }
    button:active, a.button:active, select:active {
        transform: translateY(0);
        box-shadow: 0 1px 4px var(--shadow-light) inset;
    }

    /* Card/Panel Base Styling */
    .card-panel {
      border-radius: 16px;
      box-shadow: 0 6px 18px var(--shadow-light), 0 10px 30px var(--shadow-medium);
      background: var(--background-white-card);
      border: 1px solid rgba(0,0,0,0.05);
      padding: 20px;
      box-sizing: border-box;
    }

    /* Topbar styling */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--background-white-card);
      padding: 10px 20px;
      border-bottom: 1px solid var(--border-light);
      box-shadow: 0 2px 4px var(--shadow-light);
      min-height: 50px;
    }
    .hospital-info-box {
        background-color: var(--primary-blue-light);
        color: var(--primary-blue-dark);
        padding: 8px 15px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95em;
        box-shadow: 0 1px 3px var(--shadow-light);
    }
    .topbar button {
      padding: 8px 15px;
      font-size: 14px;
      margin-left: 10px;
      margin-right: 0;
      color: var(--text-light);
      border-radius: 6px;
    }
    .topbar button:first-of-type {
        background-color: var(--primary-blue);
    }
    .topbar button:first-of-type:hover {
        background-color: var(--primary-blue-dark);
    }
    .topbar button:last-of-type {
        background-color: var(--error-red);
    }
    .topbar button:last-of-type:hover {
        background-color: #bb2d3b;
    }


    body.dark .topbar {
      background-color: #2a2a2a;
      border-color: #444;
    }
    body.dark .hospital-info-box {
        background-color: var(--primary-blue-dark);
        color: var(--primary-blue-light);
        box-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    .content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .sidebar {
      width: 200px;
      background: var(--background-white-card);
      padding: 20px;
      box-shadow: 2px 0 5px var(--shadow-light);
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
        margin: 0 0 20px;
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 1.5em;
    }
    .sidebar button {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px 8px;
      background: #eee;
      color: var(--text-dark);
      font-weight: 500;
      text-align: center;
      border-radius: 6px;
    }
    .sidebar button.active {
        background: var(--primary-blue);
        color: var(--text-light);
        box-shadow: 0 2px 6px var(--shadow-light);
    }
    .sidebar button:hover:not(.active) {
        background: #e0e0e0;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px var(--shadow-light);
    }
    .sidebar label {
        display: flex;
        align-items: center;
        margin-top: 15px;
        font-size: 0.95em;
        color: var(--text-dark);
    }
    .sidebar input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.2);
    }
    .sidebar p {
        font-size: 0.8em;
        margin-top: auto;
        color: #777;
    }


    .main {
      flex-grow: 1;
      padding: 20px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Month Header Box */
    .month-header-box {
        background: var(--primary-blue);
        color: var(--text-light);
        padding: 15px 20px;
        text-align: center;
        font-size: 1.6em;
        font-weight: 600;
        border-radius: 16px;
        box-shadow: 0 4px 12px var(--shadow-medium);
    }

    .container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
      flex: 1;
    }
    #table {
        flex-grow: 1;
        height: 500px;
        min-width: 400px;
        /* Apply card-panel base styles */
        border-radius: 16px;
        box-shadow: 0 6px 18px var(--shadow-light), 0 10px 30px var(--shadow-medium);
        background: var(--background-white-card);
        border: 1px solid rgba(0,0,0,0.05);
        overflow: hidden;
    }
    /* Handsontable specific overrides for cell background and text */
    #table .ht_master, #table .handsontable {
        background-color: var(--background-white-card);
        color: var(--text-dark);
    }
    #table .handsontable td, #table .handsontable th {
        border-color: var(--border-darker);
    }
    #table .handsontable .htPlaceholder {
        background-color: var(--background-off-white) !important;
    }

    .summary-box {
      width: 300px;
      min-width: 280px;
      padding: 20px;
      /* Apply card-panel base styles */
      border-radius: 16px;
      box-shadow: 0 6px 18px var(--shadow-light), 0 10px 30px var(--shadow-medium);
      background: var(--background-white-card);
      border: 1px solid rgba(0,0,0,0.05);
    }
    .summary-box h3 {
        margin-top: 0;
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 1.4em;
        margin-bottom: 15px;
    }
    .summary-box p {
        font-size: 1em;
        margin-bottom: 8px;
    }
    .summary-box span {
        font-weight: 500;
    }
    canvas {
        margin-bottom: 15px;
    }

    #save-section {
      margin-top: 0px;
      text-align: center;
    }
    #save-section button {
        padding: 10px 20px;
        font-size: 1em;
        font-weight: bold;
        background-color: var(--primary-blue);
        color: var(--text-light);
        border-radius: 8px;
        box-shadow: 0 2px 6px var(--shadow-light);
    }
    #save-section button:hover {
        background-color: var(--primary-blue-dark);
        box-shadow: 0 4px 10px var(--shadow-medium);
    }
    button:active, a.button:active, select:active {
        transform: translateY(0);
        box-shadow: 0 1px 4px var(--shadow-light) inset;
    }


    .trend-chart-section {
        margin-top: 0px;
        padding: 20px;
        /* Apply card-panel base styles */
        border-radius: 16px;
        box-shadow: 0 6px 18px var(--shadow-light), 0 10px 30px var(--shadow-medium);
        background: var(--background-white-card);
        border: 1px solid rgba(0,0,0,0.05);
    }
    .trend-chart-section h3 {
        margin-top: 0;
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 1.4em;
        margin-bottom: 15px;
        text-align: center;
    }
    .trend-chart-section label {
        color: var(--text-dark);
        font-weight: 500;
    }
    .trend-chart-section select {
        padding: 10px;
        border: 1px var(--border-light) solid;
        background-color: var(--background-white-card);
        color: var(--text-dark);
        font-size: 0.95em;
        border-radius: 6px;
    }
    .trend-chart-section button {
        padding: 10px 20px;
        font-size: 0.95em;
        background-color: var(--primary-blue);
        color: var(--text-light);
        border-radius: 6px;
        box-shadow: 0 2px 6px var(--shadow-light);
    }


    /* Dark Mode overrides */
    body.dark {
      background-color: #1a1a1a;
      color: var(--text-light);
    }
    body.dark .topbar, body.dark .sidebar, body.dark .summary-box, body.dark .trend-chart-section, #table, body.dark .login-container, body.dark .signup-container, body.dark .message-container, body.dark .card, body.dark .month-header-box {
        background: #2a2a2a;
        box-shadow: 0 0 15px rgba(0,0,0,0.6);
        border-color: #444;
    }
    body.dark .hospital-info-box {
        background-color: var(--primary-blue-dark);
        color: var(--primary-blue-light);
        box-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    body.dark .topbar #hospitalName, body.dark h1, body.dark h2, body.dark h3, body.dark .user-info strong {
        color: var(--primary-blue-light);
    }
    body.dark .sidebar button {
        background: #3a3a3a;
        color: var(--text-light);
    }
    body.dark .sidebar button.active {
        background: var(--primary-blue);
    }
    body.dark .sidebar button:hover:not(.active) {
        background: #4a4a4a;
    }
    body.dark select, body.dark input {
        background-color: #3a3a3a;
        color: var(--text-light);
        border-color: #555;
    }
    body.dark #table .ht_master, body.dark #table .handsontable {
        background-color: #2a2a2a;
        color: var(--text-light);
    }
    body.dark #table .handsontable td, body.dark #table .handsontable th {
        border-color: #555;
    }
    body.dark #table .handsontable .htPlaceholder {
        background-color: #2a2a2a !important;
    }
    body.dark .summary-box p, body.dark .sidebar label, body.dark .sidebar p, body.dark .trend-chart-section label {
        color: #bbb;
    }


    /* Loading Overlay & Spinner */
    #loading-overlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .spinner {
      width: 60px;
      height: 60px;
      border: 8px solid var(--background-white-card);
      border-top-color: var(--primary-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Handsontable Cell Coloring */
    .within { background-color: #d4edda !important; color: #155724 !important; }
    .warning { background-color: #fff3cd !important; color: #856404 !important; }
    .out { background-color: #f8d7da !important; color: #721c24 !important; }

  </style>
</head>
<body>
  <div class="topbar">
    <div id="hospitalInfoBox" class="hospital-info-box">
        <span id="hospitalName">Hospital: </span>
    </div>
    <span style="flex-grow: 1;"></span>
    <button id="myProfileBtn"
            style="background-color: var(--primary-blue); color: var(--text-light);">
      My Profile
    </button>
    <button id="logoutBtn"
            style="background-color: var(--error-red); color: var(--text-light);">
      Logout
    </button>
  </div>

  <div class="content">
    <div class="sidebar">
      <h2>LINAC QA</h2>
      <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
        <button id="prevYearBtn">←</button>
        <span id="year" style="margin: 0 10px;">2025</span>
        <button id="nextYearBtn">→</button>
      </div>
      <div id="months"></div>
      <label><input type="checkbox" id="darkToggle"> Dark Mode</label>
      <p style="font-size:12px;margin-top:auto;">© 2025 QA Dashboard</p>
    </div>

    <div class="main">
      <div class="month-header-box" id="header">
        </div>
      <div class="container">
        <div id="table"></div>
        <div class="summary-box">
          <canvas id="summaryChart" width="280" height="280"></canvas>
          <h3>Summary</h3>
          <p><strong>Total Entries:</strong> <span id="total">0</span></p>
          <p style="color:var(--success-green);">✓ <strong>Within Tolerance:</strong> <span id="within">0</span></p>
          <p style="color:var(--warning-orange);">⚠ <strong>Warning:</strong> <span id="warning">0</span></p>
          <p style="color:var(--error-red);">✗ <strong>Out of Tolerance:</strong> <span id="out">0</span></p>
        </div>
      </div>
      <div id="save-section">
        <button id="saveBtn" style="font-weight:bold; background-color: var(--primary-blue); color: var(--text-light);">
            <i class="fas fa-save"></i> Save
        </button>
        <span id="lastSaved" style="margin-left:15px;font-size:14px;color:gray;"></span>
      </div>
      <div class="trend-chart-section" style="margin-top: 30px;">
        <h3>Energy Trend Analysis (Current Month)</h3>
        <div style="margin-bottom: 15px;">
          <label for="trendEnergySelect" style="font-weight: bold; margin-right: 10px;">Select Energy Type:</label>
          <select id="trendEnergySelect" style="padding: 8px; border: 1px var(--border-light) solid;">
            </select>
          <button id="showTrendBtn" style="background-color: var(--primary-blue); color: var(--text-light); margin-left: 10px;">
              <i class="fas fa-chart-line"></i> Show Trend
          </button>
        </div>
        <canvas id="trendChart" style="max-height: 350px; width: 100%;"></canvas>
      </div>
    </div>
  </div>

  <div id="loading-overlay"><div class="spinner"></div></div>

  <script type="module">
    (() => { // START IIFE

      // IMPORTANT: Firebase v9 modular imports
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js'; [cite: 1]
      import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js'; [cite: 1]
      import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js'; [cite: 1]

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyBtG_xKqhJZFXmEvJ-Y0uqTG3WurrDSRgE", [cite: 1]
        authDomain: "linac-qa-project.firebaseapp.com", [cite: 1]
        projectId: "linac-qa-project", [cite: 1]
        storageBucket: "linac-qa-project.appspot.com", [cite: 1]
        messagingSenderId: "850988733382", [cite: 1]
        appId: "1:850988733382:web:ef75d64e30deb7e37c18c7", [cite: 1]
        measurementId: "G-HFJ2CGS664" [cite: 1]
      };

      // Initialize Firebase (UPDATED V9 SYNTAX)
      const app = initializeApp(firebaseConfig); [cite: 1]
      const auth = getAuth(app); // Get auth instance 
      const db = getFirestore(app); // Get firestore instance (Firestore is used in `my_profile.html` and potentially here for future features) 

      let currentUID, currentHospital;
      let hot, summaryChart, trendChart; // Declare here so they are accessible throughout the module

      // Get references to DOM elements using their IDs
      const container = document.getElementById('table'); [cite: 1]
      const monthsDiv = document.getElementById('months'); [cite: 1]
      const header = document.getElementById('header'); [cite: 1]
      const yearLabel = document.getElementById('year'); [cite: 1]
      const lastSaved = document.getElementById('lastSaved'); [cite: 1]
      const darkToggle = document.getElementById('darkToggle'); [cite: 1]
      const saveBtn = document.getElementById('saveBtn'); [cite: 1]
      const logoutBtn = document.getElementById('logoutBtn'); [cite: 1]
      const myProfileBtn = document.getElementById('myProfileBtn'); [cite: 1]
      const prevYearBtn = document.getElementById('prevYearBtn'); [cite: 1]
      const nextYearBtn = document.getElementById('nextYearBtn'); [cite: 1]
      const showTrendBtn = document.getElementById('showTrendBtn'); [cite: 1]


      let currentDate = new Date(); currentDate.setDate(1);
      const energyTypes = ["6X","10X","15X","6X FFF","10X FFF","6E","9E","12E","15E","18E"]; [cite: 1]

      let outOfToleranceValues = []; // This array holds the current out-of-tolerance values displayed in the table. 

      // --- Core Functions ---
      function getMonthDates(date) {
        const y = date.getFullYear(), m = date.getMonth(); [cite: 1]
        const days = new Date(y, m + 1, 0).getDate(); [cite: 1]
        return Array.from({ length: days }, (_, i) => `${y}-${String(m + 1).padStart(2, '0')}-${String(i+1).padStart(2, '0')}`); [cite: 1]
      }

      function generateEmptyData(dates) {
        return energyTypes.map(e => [e, ...new Array(dates.length).fill('')]); [cite: 1]
      }

      function showLoader(){document.getElementById('loading-overlay').style.display='flex';} [cite: 1]
      function hideLoader(){document.getElementById('loading-overlay').style.display='none';} [cite: 1]

      async function loadTable() {
        showLoader(); [cite: 1]
        const dateCols = getMonthDates(currentDate); [cite: 1]
        document.getElementById('header').textContent = `${currentDate.toLocaleString('default',{month:'long'})} ${currentDate.getFullYear()}`; [cite: 1]
        yearLabel.textContent = currentDate.getFullYear(); [cite: 1]
        highlightActiveMonth(); [cite: 1]

        const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`; [cite: 1]
        try {
          const res = await fetch(`https://back-end-wrxi.onrender.com/data?month=${monthKey}&uid=${currentUID}`); [cite: 1]
          const result = await res.json(); [cite: 1]
          const data = Array.isArray(result.data) && result.data.length === energyTypes.length [cite: 1]
            ? result.data.map(r=>r.map(c=> c===null||c==="None"?"":c))
            : generateEmptyData(dateCols); [cite: 1]

          if (hot) hot.destroy(); [cite: 1]
          hot = new Handsontable(container, { [cite: 1]
            data, [cite: 1]
            rowHeaders: false, [cite: 1]
            stretchH: 'all', [cite: 1]
            height: 500, [cite: 1]
            licenseKey: 'non-commercial-and-evaluation', [cite: 1]
            colHeaders: i => i === 0 ? 'Energy' : dateCols[i - 1] || '', [cite: 1]
            columns: Array(dateCols.length + 1).fill({ type: 'text' }), [cite: 1]
            afterChange: (changes, source) => { [cite: 1]
              if (!changes || source === 'loadData') return; [cite: 1]
              updateSummaryAndChart(hot.getData()); [cite: 1]
            },
            cells: function (r, c) { [cite: 1]
              const props = {}; [cite: 1]
              if (c === 0) return props; [cite: 1]
              const v = parseFloat(this.instance.getDataAtCell(r, c)); [cite: 1]
              if (!isNaN(v)) { [cite: 1]
                props.className = Math.abs(v) <= 1.8 ? 'within' : (Math.abs(v) <= 2 ? 'warning' : 'out'); [cite: 1]
              }
              return props; [cite: 1]
            }
          });

          updateSummaryAndChart(data); [cite: 1]
        } catch(e) {
          console.error("Error loading table data:", e); [cite: 1]
          alert("Could not load table data. Please try again."); [cite: 1]
        } finally {
          hideLoader(); [cite: 1]
        }
      }

      function updateSummaryAndChart(data) {
        let total=0, within=0, warning=0, out=0; [cite: 1]
        outOfToleranceValues = []; // Clear and re-populate based on current table data 

        const dateCols = getMonthDates(currentDate); [cite: 1]

        data.forEach((row, rowIndex) => { [cite: 1]
          const energyType = row[0]; [cite: 1]
          row.slice(1).forEach((value, colIndex) => { [cite: 1]
            const n = parseFloat(value); [cite: 1]
            if(!isNaN(n)){ [cite: 1]
              total++; [cite: 1]
              if(Math.abs(n)<=1.8) { [cite: 1]
                  within++; [cite: 1]
              } else if(Math.abs(n)<=2) { [cite: 1]
                  warning++; [cite: 1]
              } else {
                  out++; [cite: 1]
                  outOfToleranceValues.push({ [cite: 1]
                      energy: energyType, [cite: 1]
                      date: dateCols[colIndex], [cite: 1]
                      value: n [cite: 1]
                  });
              }
            }
          });
        });
        document.getElementById("total").textContent = total; [cite: 1]
        document.getElementById("within").textContent = within; [cite: 1]
        document.getElementById("warning").textContent = warning; [cite: 1]
        document.getElementById("out").textContent = out; [cite: 1]

        const ctx = document.getElementById('summaryChart').getContext('2d'); [cite: 1]
        if (summaryChart) summaryChart.destroy(); [cite: 1]
        summaryChart = new Chart(ctx, { [cite: 1]
          type: 'pie', [cite: 1]
          data: { [cite: 1]
            labels: ['Within Tolerance','Warning','Out of Tolerance'], [cite: 1]
            datasets: [{ data: [within,warning,out], backgroundColor: ['#66cc66','#ffcc00','#ff6666'] }] [cite: 1]
          }
        });
      }

      async function manualSave() {
        showLoader(); [cite: 1]
        const changedData = hot.getData(); [cite: 1]
        const month = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`; [cite: 1]
        try {
          // Save the LINAC QA data first
          const saveResponse = await fetch('https://back-end-wrxi.onrender.com/save',{ [cite: 1]
            method:'POST', [cite: 1]
            headers: {'Content-Type':'application/json'}, [cite: 1]
            body: JSON.stringify({ data: changedData, month, uid: currentUID }) [cite: 1]
          });

          if (!saveResponse.ok) { [cite: 1]
              throw new Error('Failed to save data: ' + saveResponse.statusText); [cite: 1]
          }

          lastSaved.textContent = "Last Saved: " + new Date().toLocaleString(); [cite: 1]
          alert("Data saved successfully!"); [cite: 1]

          // After saving, trigger the alert check on the backend.
          // We always call it if there are current outOfToleranceValues,
          // or if we have a lastSaved timestamp (implying data was present),
          // so the backend can compare and potentially send a 'resolved' alert.
          if (outOfToleranceValues.length > 0 || lastSaved.textContent !== '') { [cite: 1]
              const alertResponse = await fetch('https://back-end-wrxi.onrender.com/send-alert', { [cite: 1]
                  method: 'POST', [cite: 1]
                  headers: { [cite: 1]
                      'Content-Type': 'application/json' [cite: 1]
                  },
                  body: JSON.stringify({ [cite: 1]
                      outValues: outOfToleranceValues, [cite: 1]
                      hospitalName: currentHospital, [cite: 1]
                      uid: currentUID, // Pass UID to backend for context 
                      month: month      // Pass month to backend for context 
                  })
              });

              const alertResult = await alertResponse.json(); [cite: 1]
              if (alertResult.status === 'alert sent') { [cite: 1]
                  console.log("Email alert sent for current out of tolerance values."); [cite: 1]
              } else if (alertResult.status === 'no_change') { [cite: 1]
                  console.log("No new out-of-tolerance values or changes. Email not sent."); [cite: 1]
              } else {
                  console.warn("Could not send email alert:", alertResult.message || alertResult.status); [cite: 1]
                  alert("Alert email could not be sent: " + (alertResult.message || "Unknown error. Check console.")); [cite: 1]
              }
          } else {
              console.log("No out-of-tolerance values to send for alert and no prior save to trigger a resolution check."); [cite: 1]
          }

        } catch(err){
          console.error("Operation failed:", err); [cite: 1]
          alert("Operation failed: " + err.message); [cite: 1]
        } finally{
          hideLoader(); [cite: 1]
        }
      }

      // These functions were global and are now module-scoped, requiring event listeners
      function changeMonth(m){ currentDate = new Date(currentDate.getFullYear(), m, 1); loadTable(); updateTrendChart(); } [cite: 1]
      function changeYear(o){ currentDate = new Date(currentDate.getFullYear()+o, currentDate.getMonth(), 1); loadTable(); updateTrendChart(); } [cite: 1]
      function toggleDarkMode(){ document.body.classList.toggle('dark'); } [cite: 1]

      function buildMonthButtons(){
        const months=['January','February','March','April','May','June','July','August','September','October','November','December']; [cite: 1]
        monthsDiv.innerHTML=''; [cite: 1]
        months.forEach((m,i)=>{ [cite: 1]
          const btn = document.createElement('button'); [cite: 1]
          btn.textContent = m; [cite: 1]
          // Assign event listener programmatically
          btn.addEventListener('click', () => changeMonth(i));
          monthsDiv.appendChild(btn); [cite: 1]
        });
        highlightActiveMonth(); [cite: 1]
      }

      function highlightActiveMonth(){
        [...monthsDiv.querySelectorAll('button')].forEach((btn,i)=>{ [cite: 1]
          btn.classList.toggle('active', i === currentDate.getMonth()); [cite: 1]
        });
      }

      function populateTrendEnergySelect() {
          const select = document.getElementById('trendEnergySelect'); [cite: 1]
          select.innerHTML = ''; [cite: 1]
          energyTypes.forEach(energy => { [cite: 1]
              const option = document.createElement('option'); [cite: 1]
              option.value = energy; [cite: 1]
              option.textContent = energy; [cite: 1]
              select.appendChild(option); [cite: 1]
          });
          if (energyTypes.length > 0) { [cite: 1]
              select.value = energyTypes[0]; [cite: 1]
              updateTrendChart(); [cite: 1]
          }
      }

      async function updateTrendChart() {
          showLoader(); [cite: 1]
          const selectedEnergy = document.getElementById('trendEnergySelect').value; [cite: 1]
          if (!selectedEnergy) { [cite: 1]
              hideLoader(); [cite: 1]
              alert("Please select an energy type for trend analysis."); [cite: 1]
              return;
          }

          const dataPoints = []; [cite: 1]
          const labels = []; [cite: 1]
          const currentYear = currentDate.getFullYear(); [cite: 1]
          const currentMonth = currentDate.getMonth() + 1; [cite: 1]

          const daysInMonth = new Date(currentYear, currentMonth, 0).getDate(); [cite: 1]

          const monthKey = `${currentYear}-${String(currentMonth).padStart(2,'0')}`; [cite: 1]
          try {
              const res = await fetch(`https://back-end-wrxi.onrender.com/data?month=${monthKey}&uid=${currentUID}`); [cite: 1]
              const result = await res.json(); [cite: 1]
              const monthData = result.data; [cite: 1]

              const energyRow = monthData.find(row => row[0] === selectedEnergy); [cite: 1]

              if (energyRow) { [cite: 1]
                  for (let i = 0; i < daysInMonth; i++) { [cite: 1]
                      const value = energyRow[i + 1]; [cite: 1]
                      const n = parseFloat(value); [cite: 1]
                      dataPoints.push(isNaN(n) ? null : n); [cite: 1]
                      labels.push(String(i + 1).padStart(2, '0')); [cite: 1]
                  }
              } else {
                  for (let i = 0; i < daysInMonth; i++) { [cite: 1]
                      dataPoints.push(null); [cite: 1]
                      labels.push(String(i + 1).padStart(2, '0')); [cite: 1]
                  }
              }

              const ctx = document.getElementById('trendChart').getContext('2d'); [cite: 1]
              if (trendChart) trendChart.destroy(); [cite: 1]

              trendChart = new Chart(ctx, { [cite: 1]
                  type: 'line', [cite: 1]
                  data: { [cite: 1]
                      labels: labels, [cite: 1]
                      datasets: [{ [cite: 1]
                          label: `${selectedEnergy} Output Trend (${currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })})`, [cite: 1]
                          data: dataPoints, [cite: 1]
                          borderColor: '#007bff', [cite: 1]
                          backgroundColor: 'rgba(0, 123, 255, 0.2)', [cite: 1]
                          fill: false, [cite: 1]
                          tension: 0.1, [cite: 1]
                          spanGaps: true [cite: 1]
                      }]
                  },
                  options: { [cite: 1]
                      responsive: true, [cite: 1]
                      maintainAspectRatio: false, [cite: 1]
                      scales: { [cite: 1]
                          y: { [cite: 1]
                              beginAtZero: false, [cite: 1]
                              title: { [cite: 1]
                                  display: true, [cite: 1]
                                  text: 'Output Value (%)' [cite: 1]
                              },
                              min: -3, [cite: 1]
                              max: 3, [cite: 1]
                              ticks: { [cite: 1]
                                  callback: function(value, index, values) { [cite: 1]
                                      return value.toFixed(1) + '%'; [cite: 1]
                                  }
                              }
                          },
                          x: { [cite: 1]
                              title: { [cite: 1]
                                  display: true, [cite: 1]
                                  text: 'Day of Month' [cite: 1]
                              }
                          }
                      },
                      plugins: { [cite: 1]
                          tooltip: { [cite: 1]
                              callbacks: { [cite: 1]
                                  label: function(context) { [cite: 1]
                                      return context.dataset.label + ': ' + (context.parsed.y !== null ? context.parsed.y.toFixed(2) + '%' : 'No Data'); [cite: 1]
                                  }
                              }
                          }
                      }
                  }
              });

          } catch (error) {
              console.error("Error fetching trend data:", error); [cite: 1]
              alert("Could not load trend data. Please try again."); [cite: 1]
          } finally {
              hideLoader(); [cite: 1]
          }
      }

      // This is the correct place to attach event listeners,
      // ensuring the DOM elements are available and functions are defined within the module scope.
      onAuthStateChanged(auth, user => { [cite: 1]
        if (user) {
          currentUID = user.uid; [cite: 1]
          currentHospital = localStorage.getItem("hospitalName") || (user.email?.split('@')[0] ?? 'UNKNOWN').toUpperCase(); [cite: 1]
          const userStatus = localStorage.getItem("userStatus"); [cite: 1]

          if (userStatus === 'pending' || userStatus === 'rejected' || userStatus === 'unknown') { [cite: 1]
              alert("Your account status is: " + userStatus.toUpperCase() + ". Please await admin approval or contact support.");
              logout(); // Use the new logout function 
              return;
          }

          localStorage.setItem("uid", currentUID); [cite: 1]
          document.getElementById("hospitalName").textContent = "Hospital: " + currentHospital; [cite: 1]
          buildMonthButtons(); [cite: 1]
          loadTable(); [cite: 1]
          populateTrendEnergySelect(); [cite: 1]

          // Attach all event listeners here, after authentication and DOM is ready
          saveBtn.addEventListener('click', manualSave); [cite: 1]
          logoutBtn.addEventListener('click', logout); [cite: 1]
          myProfileBtn.addEventListener('click', () => { window.location.href='my_profile.html'; }); [cite: 1]
          darkToggle.addEventListener('change', toggleDarkMode); [cite: 1]
          prevYearBtn.addEventListener('click', () => changeYear(-1)); [cite: 1]
          nextYearBtn.addEventListener('click', () => changeYear(1)); [cite: 1]
          showTrendBtn.addEventListener('click', updateTrendChart); [cite: 1]

        } else {
          window.location.href = "login.html"; [cite: 1]
        }
      });

    })(); // END IIFE

  </script>
</body>
</html>
