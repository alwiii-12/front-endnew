<!DOCTYPE html>
<html lang="="en">
<head>
  <meta charset="UTF-8" />
  <title>LINAC Output - Monthly Save</title>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
    }
    #container {
      width: 75%;
    }
    #summary-box {
      width: 20%;
      padding: 20px;
      border-radius: 8px;
      background-color: #f8f8f8;
    }
    canvas {
      margin-bottom: 20px;
    }
    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .nav-buttons button {
      padding: 5px 10px;
    }
  </style>
</head>
<body>

<div id="container">
  <div class="nav-buttons">
    <button onclick="prevMonth()">â¬… Prev</button>
    <h3 id="monthTitle">March 2025</h3>
    <button onclick="nextMonth()">Next âž¡</button>
  </div>
  <div id="hot"></div>
  <button onclick="saveToDatabase()" style="margin-top: 10px;">ðŸ’¾ Save to Database</button>
  <p id="saveStatus" style="color: green; font-weight: bold;"></p>
</div>

<div id="summary-box">
  <canvas id="summaryChart"></canvas>
  <h3>Summary</h3>
  <p><strong>Total Entries:</strong> <span id="totalCount">0</span></p>
  <p style="color: green;"><strong>âœ” Within Tolerance:</strong> <span id="passCount">0</span></p>
  <p style="color: orange;"><strong>âš  Warning:</strong> <span id="warningCount">0</span></p>
  <p style="color: red;"><strong>âœ˜ Out of Tolerance:</strong> <span id="failCount">0</span></p>
</div>

<script>
  const energies = ['6X', '10X', '15X', '6X FFF', '10X FFF', '6E', '9E', '12E', '15E', '18E'];
  const tolerance = 2;
  const warningRange = 0.1;

  let currentMonthIndex = 2; // March
  const year = 2025;
  const monthNames = [
    "January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"
  ];

  const container = document.getElementById('hot');
  let hot = null;
  let summaryChart = null;
  const monthlyData = {}; // ðŸ§  Memory store

  function getMonthKey() {
    return `${year}-${String(currentMonthIndex + 1).padStart(2, '0')}`;
  }

  function generateHeaders(monthIndex) {
    const days = new Date(year, monthIndex + 1, 0).getDate();
    const headers = ['Energy'];
    for (let d = 1; d <= days; d++) {
      headers.push(`${d.toString().padStart(2, '0')}-${monthNames[monthIndex].slice(0, 3)}`);
    }
    return headers;
  }

  function generateEmptyData(headers) {
    return energies.map(energy => [energy, ...Array(headers.length - 1).fill('')]);
  }

  function loadMonth(index) {
    const key = getMonthKey();
    const headers = generateHeaders(index);

    if (!monthlyData[key]) {
      monthlyData[key] = generateEmptyData(headers);
    }

    document.getElementById('monthTitle').innerText = `${monthNames[index]} ${year}`;

    if (hot) {
      hot.updateSettings({
        data: monthlyData[key],
        colHeaders: headers
      });
    } else {
      hot = new Handsontable(container, {
        data: monthlyData[key],
        colHeaders: headers,
        rowHeaders: true,
        width: '100%',
        height: 400,
        licenseKey: 'non-commercial-and-evaluation',
        stretchH: 'all',
        afterChange: function (changes, source) {
          if (['edit', 'Autofill.fill', 'paste', 'CopyPaste.paste'].includes(source)) {
            updateSummary();
          }
        },
        afterPaste: function () {
          updateSummary();
        }
      });
    }

    updateSummary();
  }

  function prevMonth() {
    saveCurrentData();
    currentMonthIndex = (currentMonthIndex - 1 + 12) % 12;
    loadMonth(currentMonthIndex);
  }

  function nextMonth() {
    saveCurrentData();
    currentMonthIndex = (currentMonthIndex + 1) % 12;
    loadMonth(currentMonthIndex);
  }

  function saveCurrentData() {
    if (hot) {
      const key = getMonthKey();
      monthlyData[key] = hot.getData();
    }
  }

  function updateSummary() {
    let pass = 0, warn = 0, fail = 0, total = 0;
    const data = hot.getData();

    for (let r = 0; r < data.length; r++) {
      for (let c = 1; c < data[r].length; c++) {
        const val = parseFloat(data[r][c]);
        if (!isNaN(val)) {
          total++;
          if (Math.abs(val) <= tolerance - warningRange) pass++;
          else if (Math.abs(val) <= tolerance) warn++;
          else fail++;
        }
      }
    }

    document.getElementById('passCount').innerText = pass;
    document.getElementById('failCount').innerText = fail;
    document.getElementById('warningCount').innerText = warn;
    document.getElementById('totalCount').innerText = total;

    const ctx = document.getElementById('summaryChart').getContext('2d');
    if (summaryChart) summaryChart.destroy();
    summaryChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Within Tolerance', 'Warning', 'Out of Tolerance'],
        datasets: [{
          data: [pass, warn, fail],
          backgroundColor: ['#8bc34a', '#ffeb3b', '#f44336']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' }
        }
      }
    });
  }

  function saveToDatabase() {
    const data = hot.getData();
    const headers = hot.getColHeader();
    const payload = {
      month: monthNames[currentMonthIndex],
      year: year,
      headers: headers,
      rows: data
    };

    fetch("https://back-end-wrxi.onrender.com/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
      .then(res => res.json())
      .then(result => {
        document.getElementById("saveStatus").innerText = result.message || "Data saved.";
      })
      .catch(err => {
        console.error("Save error:", err);
        document.getElementById("saveStatus").innerText = "Error saving data.";
      });
  }

  // Load first month
  loadMonth(currentMonthIndex);
</script>
</body>
</html>
