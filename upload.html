<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LINAC Output - Monthly View</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      margin: 20px;
    }
    .layout {
      display: flex;
      justify-content: space-between;
    }
    .table-box {
      width: 75%;
    }
    .summary-box {
      width: 23%;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 10px;
    }
    canvas {
      max-width: 100%;
    }
    .month-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .month-nav button {
      padding: 5px 15px;
      font-weight: bold;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <div class="month-nav">
    <button onclick="changeMonth(-1)">⬅ Previous</button>
    <h2 id="monthLabel">March 2025</h2>
    <button onclick="changeMonth(1)">Next ➡</button>
  </div>

  <div class="layout">
    <div class="table-box">
      <div id="table"></div>
    </div>

    <div class="summary-box">
      <canvas id="pieChart"></canvas>
      <div id="summary" style="margin-top: 20px;"></div>
    </div>
  </div>

  <script>
    const tolerance = 2;
    const energies = ["6X", "10X", "15X", "6X FFF", "10X FFF", "6E", "9E", "12E", "15E", "18E"];
    const dataStore = {}; // stores month-wise data

    let currentMonth = 2; // March (0 = Jan, 1 = Feb, ...)
    let currentYear = 2025;
    let hot = null;
    const container = document.getElementById('table');

    const ctx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Within Tolerance', 'Warning', 'Out of Tolerance'],
        datasets: [{
          data: [0, 0, 0],
          backgroundColor: ['#9be7a7', '#ffe082', '#ff8a80'],
        }]
      }
    });

    function getDaysInMonth(month, year) {
      const date = new Date(year, month, 1);
      const days = [];
      while (date.getMonth() === month) {
        const d = date.getDate().toString().padStart(2, '0');
        const m = date.toLocaleString('default', { month: 'short' });
        days.push(`${d}-${m}`);
        date.setDate(date.getDate() + 1);
      }
      return days;
    }

    function getMonthKey() {
      return `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
    }

    function loadMonth(month, year) {
      const days = getDaysInMonth(month, year);
      const key = getMonthKey();
      if (!dataStore[key]) {
        dataStore[key] = energies.map(energy => [energy, ...Array(days.length).fill(null)]);
      }

      const colHeaders = ["Energy", ...days];
      const columns = [{ readOnly: true }, ...days.map(() => ({ type: 'numeric', numericFormat: { pattern: '0.0' } }))];

      if (hot) {
        hot.updateSettings({
          data: dataStore[key],
          colHeaders: colHeaders,
          columns: columns
        });
      } else {
        hot = new Handsontable(container, {
          data: dataStore[key],
          colHeaders: colHeaders,
          rowHeaders: true,
          licenseKey: 'non-commercial-and-evaluation',
          columns: columns,
          stretchH: 'all',
          height: 'auto',
          afterChange: function (changes, source) {
            if (source === 'edit' || source === 'Autofill.fill') {
              updateSummary();
            }
          }
        });
      }

      document.getElementById("monthLabel").innerText = `${days[0].split('-')[1]} ${year}`;
      updateSummary();
    }

    function changeMonth(offset) {
      currentMonth += offset;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      } else if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
      }
      loadMonth(currentMonth, currentYear);
    }

    function updateSummary() {
      let pass = 0, warn = 0, fail = 0;
      const updatedData = hot.getData();
      updatedData.forEach(row => {
        row.slice(1).forEach(val => {
          if (val === null || val === '') return;
          const absVal = Math.abs(parseFloat(val));
          if (absVal < tolerance) pass++;
          else if (absVal === tolerance) warn++;
          else fail++;
        });
      });

      pieChart.data.datasets[0].data = [pass, warn, fail];
      pieChart.update();

      const total = pass + warn + fail;
      document.getElementById('summary').innerHTML = `
        <h3>Summary</h3>
        <p><strong>Total Entries:</strong> ${total}</p>
        <p style="color: green;"><strong>✔ Within Tolerance:</strong> ${pass}</p>
        <p style="color: orange;"><strong>⚠ Warning:</strong> ${warn}</p>
        <p style="color: red;"><strong>✖ Out of Tolerance:</strong> ${fail}</p>
      `;
    }

    // Initial load
    loadMonth(currentMonth, currentYear);
  </script>
</body>
</html>
