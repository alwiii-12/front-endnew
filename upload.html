<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINAC QA Data Entry</title>
  <link rel="icon" href="/favicon.png" type="image/png">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css" />
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <style>
    /* --- Styles for upload.html specific enhancements --- */
    .actions-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
    }
    #annotationModal textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        box-sizing: border-box;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 1em;
        resize: vertical;
    }
    .topbar .header-buttons {
        display: flex;
        gap: 15px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div id="hospitalInfoBox" class="hospital-info-box">Hospital: <span id="hospitalName"></span></div>
    <div class="header-buttons">
        <a href="my_profile.html" id="myProfileBtn" class="button">My Profile</a>
        <button id="logoutBtn" title="Logout" aria-label="Logout" class="header-btn" style="background-color: var(--status-error); color: white;"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </div>
  <div class="content">
    <div class="sidebar">
      <h2>LINAC QA</h2>
     <div class="year-nav">
        <button id="prevYearBtn" aria-label="Previous Year"><i class="fas fa-chevron-left"></i></button>
        <span id="year">2025</span>
        <button id="nextYearBtn" aria-label="Next Year"><i class="fas fa-chevron-right"></i></button>
    </div>
      <div id="months"></div>
      <label style="margin-top: auto; padding-top: 20px;"><input type="checkbox" id="darkToggle"> Dark Mode</label>
      <p>© 2025 QA Dashboard</p>
    </div>
    <div class="main">
      <div class="month-header-box" id="header"></div>
      <div class="tab-nav">
        <button class="tab-nav-button active" onclick="switchTab('output')">Output</button>
        <button class="tab-nav-button" onclick="switchTab('flatness')">Flatness</button>
        <button class="tab-nav-button" onclick="switchTab('inline')">Inline Symmetry</button>
        <button class="tab-nav-button" onclick="switchTab('crossline')">Crossline Symmetry</button>
      </div>
      <div id="tab-content-output" class="tab-content active"></div>
      <div id="tab-content-flatness" class="tab-content"></div>
      <div id="tab-content-inline" class="tab-content"></div>
      <div id="tab-content-crossline" class="tab-content"></div>
    </div>
  </div>
  <div id="loading-overlay"><div class="spinner"></div></div>
  <div id="chat-bubble"><i class="fas fa-comment-dots"></i></div>
  <div id="chat-window">
    <div id="chat-header"><span>QA Copilot</span><button id="close-chat-btn"><i class="fas fa-times"></i></button></div>
    <div id="chat-body"><div class="chat-message bot">Hello! Ask me about your data.</div></div>
    <div id="chat-input-area"><input type="text" id="chat-input" placeholder="Type..."><button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button></div>
  </div>

  <!-- NEW: Custom Annotation Modal -->
  <div id="annotationModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="hideAnnotationModal()">&times;</span>
        <h3 id="annotationModalTitle">Add/Edit Annotation</h3>
        <textarea id="annotationInput" placeholder="Enter your note here..."></textarea>
        <div class="modal-buttons">
            <button id="saveAnnotationBtn" class="save-btn">Save Note</button>
            <button class="cancel-btn" onclick="hideAnnotationModal()">Cancel</button>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-check-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appCheck = firebase.appCheck();
        const BACKEND_URL = "https://back-end-wrxi.onrender.com";
        let currentUID, currentHospital;
        let currentDate = new Date();
        currentDate.setDate(1);
        const energyTypes = ["6X", "10X", "15X", "6X FFF", "10X FFF", "6E", "9E", "12E", "15E", "18E"];
        const dataTypesConfig = {
          output: { label: 'Output', tolerance: 2.0, warning: 1.8, initialized: false, yAxisMin: -3, yAxisMax: 3 },
          flatness: { label: 'Flatness', tolerance: 1.0, warning: 0.9, initialized: false, yAxisMin: -2, yAxisMax: 2 },
          inline: { label: 'Inline Symmetry', tolerance: 1.0, warning: 0.9, initialized: false, yAxisMin: -2, yAxisMax: 2 },
          crossline: { label: 'Crossline Symmetry', tolerance: 1.0, warning: 0.9, initialized: false, yAxisMin: -2, yAxisMax: 2 }
        };
        let instances = { output: {}, flatness: {}, inline: {}, crossline: {} };
        let activeTab = 'output';
        const yearLabel = document.getElementById('year');
        const monthsDiv = document.getElementById('months');
        const header = document.getElementById('header');

        // --- NEW: Annotation Modal Elements ---
        const annotationModal = document.getElementById('annotationModal');
        const annotationModalTitle = document.getElementById('annotationModalTitle');
        const annotationInput = document.getElementById('annotationInput');
        const saveAnnotationBtn = document.getElementById('saveAnnotationBtn');
        let currentAnnotationKey = null;

        function showLoader() { document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loading-overlay').style.display = 'none'; }
        
        function logout() {
          showLoader();
          auth.signOut().then(() => {
            localStorage.clear();
            window.location.replace("login.html");
          }).catch(err => {
            hideLoader();
          });
        }

        function generateTabContentHTML(dataType) {
            const config = dataTypesConfig[dataType];
            return `
                <div class="container">
                    <div id="table-${dataType}" class="table-container"></div>
                    <div class="summary-box card-panel">
                        <canvas id="summaryChart-${dataType}"></canvas>
                        <h3>${config.label} Summary</h3>
                        <p><strong>Total Entries:</strong> <span id="total-${dataType}">0</span></p>
                        <p style="color:var(--status-success);">✓ Within Tolerance: <span id="within-${dataType}">0</span></p>
                        <p style="color:var(--status-warning);">⚠ Warning: <span id="warning-${dataType}">0</span></p>
                        <p style="color:var(--status-error);">✗ Out of Tolerance: <span id="out-${dataType}">0</span></p>
                    </div>
                </div>
                <div class="actions-section">
                    <button class="save-btn" onclick="manualSave('${dataType}')"><i class="fas fa-save"></i> Save ${config.label}</button>
                    <button class="export-btn" onclick="exportToExcel('${dataType}')" style="background-color: var(--status-success);"><i class="fas fa-file-excel"></i> Export ${config.label}</button>
                    <span id="lastSaved-${dataType}"></span>
                </div>
                <div class="trend-chart-section card-panel">
                    <h3>${config.label} Trend Analysis</h3>
                    <div><label>Select Energy:</label><select id="trendEnergySelect-${dataType}" onchange="updateTrendChart('${dataType}')"></select></div>
                    <div class="chart-wrapper" style="position: relative; height: 40vh; width: 100%;">
                        <canvas id="trendChart-${dataType}"></canvas>
                    </div>
                </div>
            `;
        }

        window.switchTab = async function(dataType) {
            activeTab = dataType;
            document.querySelectorAll('.tab-nav-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${dataType}')"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-content-${dataType}`).classList.add('active');
            if (!dataTypesConfig[dataType].initialized) {
                await initializeTab(dataType);
            }
        }

        async function initializeTab(dataType) {
            showLoader();
            document.getElementById(`tab-content-${dataType}`).innerHTML = generateTabContentHTML(dataType);
            populateTrendEnergySelect(dataType);
            await loadDataForTab(dataType);
            dataTypesConfig[dataType].initialized = true;
            hideLoader();
        }

        async function loadDataForTab(dataType) {
            showLoader();
            const config = dataTypesConfig[dataType];
            const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            try {
                const appCheckTokenResponse = await appCheck.getToken(false);
                const res = await fetch(`${BACKEND_URL}/data?month=${monthKey}&uid=${currentUID}&dataType=${dataType}`, {
                    headers: { "X-Firebase-AppCheck": appCheckTokenResponse.token }
                });
                if (!res.ok) throw new Error(`Server error: ${res.statusText}`);
                const result = await res.json();
                const dateCols = getMonthDates(currentDate);
                let data = Array.isArray(result.data) && result.data.length > 0
                    ? result.data.map(r => r.map(c => c === null || c === "None" ? "" : c))
                    : energyTypes.map(e => [e, ...new Array(dateCols.length).fill('')]);
                const container = document.getElementById(`table-${dataType}`);
                if (instances[dataType].hot) instances[dataType].hot.destroy();
                instances[dataType].hot = new Handsontable(container, {
                    data, rowHeaders: false, stretchH: 'all', height: 500, licenseKey: 'non-commercial-and-evaluation',
                    colHeaders: i => i === 0 ? 'Energy' : dateCols[i - 1] || '',
                    columns: Array(dateCols.length + 1).fill({ type: 'text' }),
                    afterChange: (changes, source) => {
                        if (source !== 'loadData') {
                            updateSummaryAndChart(dataType, instances[dataType].hot.getData());
                            updateTrendChart(dataType); 
                        }
                    },
                    cells: function (r, c) {
                        const props = { readOnly: false, className: '' };
                        if (c === 0) props.readOnly = true;
                        const today = new Date();
                        const isFuture = currentDate.getFullYear() > today.getFullYear() ||
                                       (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() > today.getMonth()) ||
                                       (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() === today.getMonth() && c > today.getDate());
                        if (isFuture) {
                            props.readOnly = true;
                            props.className = 'future-cell-readonly';
                        } else {
                            const val = parseFloat(this.instance.getDataAtCell(r, c));
                            if (!isNaN(val)) {
                                if (Math.abs(val) < config.warning) props.className = 'within';
                                else if (Math.abs(val) <= config.tolerance) props.className = 'warning';
                                else props.className = 'out';
                            }
                        }
                        return props;
                    }
                });
                updateSummaryAndChart(dataType, data);
                updateTrendChart(dataType);
            } catch (e) { console.error(`Error loading data for ${dataType}:`, e); } finally { hideLoader(); }
        }

        function getOutOfToleranceValues(dataType) {
            const hotInstance = instances[dataType].hot;
            if (!hotInstance) return [];
            const data = hotInstance.getData();
            const config = dataTypesConfig[dataType];
            const outValues = [];
            const dateCols = getMonthDates(currentDate);
            data.forEach((row) => {
                const energy = row[0];
                row.slice(1).forEach((value, colIndex) => {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue) && Math.abs(numValue) > config.tolerance) {
                        outValues.push({ energy, date: dateCols[colIndex], value: numValue });
                    }
                });
            });
            return outValues;
        }

        window.manualSave = async function(dataType) {
            const saveButton = document.querySelector(`.actions-section button.save-btn[onclick="manualSave('${dataType}')"]`);
            const config = dataTypesConfig[dataType];
            saveButton.disabled = true;
            saveButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Saving...`;
            const changedData = instances[dataType].hot.getData();
            const month = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            try {
                const appCheckTokenResponse = await appCheck.getToken(false);
                const token = appCheckTokenResponse.token;
                const saveResponse = await fetch(`${BACKEND_URL}/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', "X-Firebase-AppCheck": token },
                    body: JSON.stringify({ data: changedData, month, uid: currentUID, dataType: dataType })
                });
                if (!saveResponse.ok) { throw new Error(`Save failed: ${await saveResponse.text()}`); }
                document.getElementById(`lastSaved-${dataType}`).textContent = "Saved: " + new Date().toLocaleTimeString();
                const outOfToleranceValues = getOutOfToleranceValues(dataType);
                await fetch(`${BACKEND_URL}/send-alert`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Firebase-AppCheck': token },
                    body: JSON.stringify({ outValues: outOfToleranceValues, hospitalName: currentHospital, uid: currentUID, month, dataType, tolerance: config.tolerance })
                });
            } catch (err) {
                console.error(`Save process failed for ${dataType}:`, err);
                document.getElementById(`lastSaved-${dataType}`).textContent = "Save Failed!";
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = `<i class="fas fa-save"></i> Save ${config.label}`;
            }
        }

        window.exportToExcel = async function(dataType) { /* ... existing code ... */ }
        function updateSummaryAndChart(dataType, data) { /* ... existing code ... */ }
        function populateTrendEnergySelect(dataType) { /* ... existing code ... */ }

        // --- NEW: Annotation Modal Functions ---
        function showAnnotationModal(key, existingText, energy, date) {
            currentAnnotationKey = key;
            annotationModalTitle.textContent = `Note for ${energy} on ${date}`;
            annotationInput.value = existingText;
            annotationModal.style.display = 'flex';
        }

        window.hideAnnotationModal = function() {
            annotationModal.style.display = 'none';
            currentAnnotationKey = null;
        }
        
        saveAnnotationBtn.addEventListener('click', async () => {
            if (!currentAnnotationKey) return;
            const note = annotationInput.value;
            const [energy, fullDate] = currentAnnotationKey.split(/-(.*)/s);
            const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            showLoader();
            try {
                const appCheckTokenResponse = await appCheck.getToken(false);
                await fetch(`${BACKEND_URL}/save-annotation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', "X-Firebase-AppCheck": appCheckTokenResponse.token },
                    body: JSON.stringify({
                        uid: currentUID, month: monthKey, key: currentAnnotationKey,
                        data: { text: note, dataType: activeTab, energy: energy }
                    })
                });
                hideAnnotationModal();
                await updateTrendChart(activeTab); 
            } catch (e) { console.error("Failed to save annotation", e); } 
            finally { hideLoader(); }
        });


        window.updateTrendChart = async function(dataType) {
            const hotInstance = instances[dataType].hot;
            if (!hotInstance) return;
            const data = hotInstance.getData();
            const selectElement = document.getElementById(`trendEnergySelect-${dataType}`);
            if (!selectElement) return;
            const selectedEnergy = selectElement.value;
            const energyRow = data.find(row => row[0] === selectedEnergy);
            const dataPoints = energyRow ? energyRow.slice(1).map(val => { const num = parseFloat(val); return isFinite(num) ? num : null; }) : [];
            const labels = getMonthDates(currentDate);
            const shortLabels = labels.map(d => d.split('-')[2]);
            const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            let annotations = {};
            try {
                const appCheckTokenResponse = await appCheck.getToken(false);
                const res = await fetch(`${BACKEND_URL}/annotations?month=${monthKey}&dataType=${dataType}&uid=${currentUID}`, { headers: { "X-Firebase-AppCheck": appCheckTokenResponse.token } });
                if(res.ok) annotations = await res.json();
            } catch (e) { console.error("Could not fetch annotations", e); }
            const canvasElement = document.getElementById(`trendChart-${dataType}`);
            const config = dataTypesConfig[dataType];
            const ctx = canvasElement.getContext('2d');
            if (instances[dataType].trendChart) instances[dataType].trendChart.destroy();
            instances[dataType].trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: shortLabels,
                    datasets: [{ label: `${selectedEnergy} Trend`, data: dataPoints, borderColor: '#007bff', tension: 0.1, spanGaps: true }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { min: config.yAxisMin, max: config.yAxisMax, title: { display: true, text: 'Value (%)' } } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const pointIndex = elements[0].index;
                            const fullDate = labels[pointIndex];
                            const annotationKey = `${selectedEnergy}-${fullDate}`;
                            const existingAnnotation = annotations[annotationKey]?.text || "";
                            // --- MODIFIED: Call custom modal instead of prompt ---
                            showAnnotationModal(annotationKey, existingAnnotation, selectedEnergy, fullDate);
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: Object.entries(annotations)
                                .filter(([, value]) => value.energy === selectedEnergy)
                                .map(([key, value]) => ({
                                    type: 'line', scaleID: 'x', value: key.split('-')[3] - 1,
                                    borderColor: 'red', borderWidth: 1, borderDash: [6, 6],
                                    label: { display: true, content: value.text, position: 'start', backgroundColor: 'rgba(255,0,0,0.7)', font: { size: 10 } }
                                }))
                        },
                        tooltip: {
                             callbacks: {
                                 afterBody: (context) => {
                                     const annotationKey = `${selectedEnergy}-${labels[context[0].dataIndex]}`;
                                     return annotations[annotationKey] ? "Note: " + annotations[annotationKey].text : "";
                                 }
                             }
                        }
                    }
                }
            });
        }
        
        function changeMonth(monthIndex) { /* ... existing code ... */ }
        function changeYear(offset) { /* ... existing code ... */ }
        function buildMonthButtons() { /* ... existing code ... */ }
        function highlightActiveMonth() { /* ... existing code ... */ }
        function getMonthDates(date) { /* ... existing code ... */ }
        function toggleDarkMode(isInitialLoad = false) { /* ... existing code ... */ }
        function addChatMessage(message, sender) { /* ... existing code ... */ }
        async function sendChatMessage() { /* ... existing code ... */ }

        window.addEventListener('pageshow', function(event) { if (event.persisted) window.location.reload(); });

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUID = user.uid;
                currentHospital = localStorage.getItem("hospitalName");
                document.getElementById("hospitalName").textContent = currentHospital;
                yearLabel.textContent = currentDate.getFullYear();
                header.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${currentDate.getFullYear()}`;
                buildMonthButtons();
                document.getElementById('prevYearBtn').onclick = () => changeYear(-1);
                document.getElementById('nextYearBtn').onclick = () => changeYear(1);
                document.getElementById('logoutBtn').onclick = logout;
                const darkToggle = document.getElementById('darkToggle');
                darkToggle.checked = localStorage.getItem('darkMode') === 'true';
                toggleDarkMode(true);
                darkToggle.addEventListener('change', () => toggleDarkMode(false));
                document.getElementById('chat-bubble').onclick = () => document.getElementById('chat-window').classList.toggle('open');
                document.getElementById('close-chat-btn').onclick = () => document.getElementById('chat-window').classList.remove('open');
                document.getElementById('chat-input').onkeypress = e => { if (e.key === 'Enter') sendChatMessage(); };
                document.getElementById('send-chat-btn').onclick = sendChatMessage;
                switchTab('output');
            } else {
                window.location.replace("login.html");
            }
        });

        window.onclick = function(event) {
            if (event.target == annotationModal) {
                hideAnnotationModal();
            }
        }
    });
  </script>
</body>
</html>
