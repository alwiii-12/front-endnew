<!DOCTYPE html>
<html>
<head>
    <title>Upload Output Variation Excel File</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        h2 {
            color: #333;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f3f3f3;
        }
    </style>
</head>
<body>
    <h2>Upload Output Variation Excel File</h2>
    <input type="file" id="excelFile">
    <button onclick="uploadFile()">Upload</button>
    <button onclick="downloadCurrentCSV()">Download CSV</button>
    <button onclick="downloadSavedCSV()">Download Saved CSV</button>

    <h3>Evaluation Results:</h3>
    <div id="results"></div>

    <script>
        let currentResults = [];

        function uploadFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            fetch('https://back-end-wrxi.onrender.com/upload', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.results) {
                    currentResults = data.results;
                    displayResults(currentResults);
                } else {
                    alert(data.error || 'Unexpected error');
                }
            });
        }

        function displayResults(results) {
            let html = '<table><tr><th>Date</th><th>Variation</th><th>Status</th></tr>';
            results.forEach(row => {
                const color = row.status === "Pass" ? "green" :
                              row.status === "Warning" ? "orange" : "red";
                html += `<tr>
                    <td>${row.date}</td>
                    <td>${row.variation.toFixed(1)}%</td>
                    <td style="color: ${color}; font-weight: bold;">${row.status}</td>
                </tr>`;
            });
            html += '</table>';
            document.getElementById('results').innerHTML = html;
        }

        function downloadCurrentCSV() {
            fetch('https://back-end-wrxi.onrender.com/download_csv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ results: currentResults })
            })
            .then(res => res.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'evaluation_results.csv';
                a.click();
            });
        }

        function downloadSavedCSV() {
            fetch('https://back-end-wrxi.onrender.com/download_saved_csv')
            .then(res => res.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'saved_evaluation_results.csv';
                a.click();
            });
        }
    </script>
</body>
</html>
