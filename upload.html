<!DOCTYPE html>
<html>
<head>
  <title>Upload LINAC Output Excel</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background-color: #f4f4f4; }
    .badge { padding: 5px 10px; border-radius: 10px; font-weight: bold; display: inline-block; }
    .within { background-color: #e6f4ea; color: #2e7d32; border: 1px solid #a5d6a7; }
    .warning { background-color: #fff9e6; color: #f57f17; border: 1px solid #ffe082; }
    .out { background-color: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
    .container { display: flex; gap: 20px; margin-top: 20px; }
    .summary-box { flex: 1; border: 1px solid #ccc; padding: 15px; border-radius: 8px; background: #fafafa; }
    .results-table { flex: 3; }
    h3 { margin-top: 0; }
  </style>
</head>
<body>
  <h2>Upload LINAC Output Excel</h2>
  <input type="file" id="excelFile" accept=".xlsx, .xls">
  <button onclick="uploadFile()">Upload</button>

  <div class="container">
    <div id="results" class="results-table"></div>
    <div id="summary" class="summary-box">
      <canvas id="summaryChart" width="200" height="200"></canvas>
      <h3>Summary</h3>
      <p><strong>Total Entries:</strong> <span id="totalCount">0</span></p>
      <p><strong>✅ Within Tolerance:</strong> <span id="passCount">0</span></p>
      <p><strong>⚠️ Warning:</strong> <span id="warningCount">0</span></p>
      <p><strong>❌ Out of Tolerance:</strong> <span id="failCount">0</span></p>
    </div>
  </div>

  <script>
    async function uploadFile() {
      const fileInput = document.getElementById('excelFile');
      const file = fileInput.files[0];

      if (!file) {
        alert("Please select a file first.");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch("https://back-end-wrxi.onrender.com/upload", {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        if (!Array.isArray(data) || data.length === 0) {
          document.getElementById('results').textContent = "Upload failed or no data returned.";
          return;
        }

        let html = '';
        const grouped = {};
        let passCount = 0, warningCount = 0, failCount = 0;

        // Group by energy
        data.forEach(entry => {
          const { energy, date, variation, status } = entry;
          if (!grouped[energy]) grouped[energy] = [];
          grouped[energy].push({ date, variation, status });

          if (status === "Within Tolerance") passCount++;
          else if (status === "Warning") warningCount++;
          else if (status === "Out of Tolerance") failCount++;
        });

        // Build grouped tables
        for (let energy in grouped) {
          html += `<h3>${energy}</h3><table>
            <thead><tr><th>Date</th><th>Variation (%)</th><th>Status</th></tr></thead><tbody>`;
          grouped[energy].forEach(entry => {
            const badgeClass = entry.status === "Within Tolerance" ? "within"
                               : entry.status === "Warning" ? "warning" : "out";
            const badgeIcon = entry.status === "Within Tolerance" ? "✅"
                               : entry.status === "Warning" ? "⚠️" : "❌";
            html += `<tr>
              <td>${entry.date}</td>
              <td>${entry.variation ?? ""}</td>
              <td><span class="badge ${badgeClass}">${badgeIcon} ${entry.status}</span></td>
            </tr>`;
          });
          html += `</tbody></table>`;
        }

        document.getElementById('results').innerHTML = html;

        // Update summary
        const totalCount = passCount + warningCount + failCount;
        document.getElementById('totalCount').textContent = totalCount;
        document.getElementById('passCount').textContent = passCount;
        document.getElementById('warningCount').textContent = warningCount;
        document.getElementById('failCount').textContent = failCount;

        // Chart
        const ctx = document.getElementById('summaryChart').getContext('2d');
        if (window._summaryChart instanceof Chart) {
          window._summaryChart.destroy();
        }
        window._summaryChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Within Tolerance', 'Warning', 'Out of Tolerance'],
            datasets: [{
              data: [passCount, warningCount, failCount],
              backgroundColor: ['#a5d6a7', '#ffe082', '#ef9a9a']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: 'Output Summary' }
            }
          }
        });

      } catch (error) {
        console.error("Upload failed:", error);
        document.getElementById('results').textContent = "Upload failed. Please try again.";
      }
    }
  </script>
</body>
</html>
