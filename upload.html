<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LINAC Output Entry</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css">
  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f5f5f5;
      color: #000;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 220px;
      background-color: #007bff;
      color: white;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .sidebar h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .sidebar button {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      background-color: white;
      color: #007bff;
      border: none;
      font-weight: bold;
      border-radius: 5px;
      cursor: pointer;
    }

    .sidebar button:hover {
      background-color: #e0e0e0;
    }

    .sidebar input[type="checkbox"] {
      margin-top: 10px;
    }

    .main {
      flex-grow: 1;
      padding: 20px;
      overflow: auto;
    }

    .header {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    #table {
      flex-grow: 1;
    }

    .summary-box {
      width: 300px;
      background-color: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
    }

    .summary-box h3 {
      margin-top: 0;
    }

    .neon-outline {
      border: 2px solid red !important;
      background-color: #ffe6e6 !important;
      color: black !important;
    }

    .warning-outline {
      border: 2px solid orange !important;
      background-color: #fff5e6 !important;
    }

    .tolerance-outline {
      border: 2px solid green !important;
      background-color: #e6ffe6 !important;
    }

    #save-section {
      margin-top: 20px;
    }

    body.dark {
      background-color: #1e1e1e;
      color: white;
    }

    body.dark .sidebar {
      background-color: #111;
      color: white;
    }

    body.dark .sidebar button {
      background-color: #333;
      color: white;
    }

    body.dark .summary-box {
      background-color: #2c2c2c;
      color: white;
      box-shadow: none;
    }

    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 8px solid #ccc;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>QA Panel</h2>
    <label for="year">Year:</label>
    <select id="year"></select>
    <label for="month">Month:</label>
    <select id="month"></select>
    <button onclick="loadTable()">Load</button>
    <button onclick="saveTable()">Save</button>
    <label><input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"> Dark Mode</label>
  </div>

  <div class="main">
    <div class="header">Daily Output Variation Entry</div>
    <div class="container">
      <div id="table"></div>
      <div class="summary-box">
        <h3>Summary</h3>
        <p id="within">Within Tolerance: 0</p>
        <p id="warning">Warning: 0</p>
        <p id="out">Out of Tolerance: 0</p>
        <canvas id="summaryChart" width="200" height="200"></canvas>
      </div>
    </div>
    <div id="save-section">
      <button onclick="saveTable()">Save Data</button>
    </div>
  </div>

  <div id="loading-overlay">
    <div class="spinner"></div>
  </div>

  <script>
    const monthSelect = document.getElementById("month");
    const yearSelect = document.getElementById("year");
    const currentDate = new Date();
    const currentMonth = currentDate.getMonth();
    const currentYear = currentDate.getFullYear();

    for (let i = 0; i < 12; i++) {
      const option = document.createElement("option");
      option.value = i;
      option.text = new Date(0, i).toLocaleString("default", { month: "long" });
      if (i === currentMonth) option.selected = true;
      monthSelect.appendChild(option);
    }

    for (let y = currentYear - 5; y <= currentYear + 5; y++) {
      const option = document.createElement("option");
      option.value = y;
      option.text = y;
      if (y === currentYear) option.selected = true;
      yearSelect.appendChild(option);
    }

    let hot;

    function createTable(daysInMonth) {
      const data = Array(10).fill().map(() => Array(daysInMonth).fill(""));

      const container = document.getElementById("table");
      hot = new Handsontable(container, {
        data,
        rowHeaders: ["X-ray1", "X-ray2", "X-ray3", "X-ray4", "X-ray5", "X-ray6", "Electron1", "Electron2", "Electron3", "Electron4"],
        colHeaders: Array.from({ length: daysInMonth }, (_, i) => i + 1),
        licenseKey: "non-commercial-and-evaluation",
        afterChange: () => {
          evaluateData();
        }
      });
    }

    function evaluateData() {
      const data = hot.getData();
      let within = 0, warning = 0, out = 0;

      for (let row = 0; row < data.length; row++) {
        for (let col = 0; col < data[0].length; col++) {
          const value = parseFloat(data[row][col]);
          let meta = hot.getCellMeta(row, col);

          if (!isNaN(value)) {
            if (Math.abs(value) <= 1.8) {
              within++;
              meta.className = 'tolerance-outline';
            } else if (Math.abs(value) <= 2.0) {
              warning++;
              meta.className = 'warning-outline';
            } else {
              out++;
              meta.className = 'neon-outline';
              sendAlert(value);
            }
          } else {
            meta.className = '';
          }
        }
      }

      hot.render();

      document.getElementById("within").innerText = "Within Tolerance: " + within;
      document.getElementById("warning").innerText = "Warning: " + warning;
      document.getElementById("out").innerText = "Out of Tolerance: " + out;

      updateChart(within, warning, out);
    }

    function updateChart(within, warning, out) {
      const ctx = document.getElementById('summaryChart').getContext('2d');
      if (window.summaryChart) window.summaryChart.destroy();

      window.summaryChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Within Tolerance', 'Warning', 'Out of Tolerance'],
          datasets: [{
            data: [within, warning, out],
            backgroundColor: ['green', 'orange', 'red']
          }]
        }
      });
    }

    function saveTable() {
      const data = hot.getData();
      const month = monthSelect.value;
      const year = yearSelect.value;
      showLoading(true);
      fetch('https://back-end-wrxi.onrender.com/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ year, month, data })
      }).then(res => res.json())
        .then(() => showLoading(false));
    }

    function loadTable() {
      const month = monthSelect.value;
      const year = yearSelect.value;
      const days = new Date(year, parseInt(month) + 1, 0).getDate();
      createTable(days);
      showLoading(true);
      fetch(`https://back-end-wrxi.onrender.com/load?year=${year}&month=${month}`)
        .then(res => res.json())
        .then(res => {
          hot.loadData(res.data || Array(10).fill().map(() => Array(days).fill("")));
          evaluateData();
          showLoading(false);
        });
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
    }

    function showLoading(show) {
      document.getElementById("loading-overlay").style.display = show ? "flex" : "none";
    }

    function sendAlert(value) {
      fetch('https://back-end-wrxi.onrender.com/send-alert', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ value })
      });
    }

    loadTable();
  </script>
</body>
</html>
