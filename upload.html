<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload LINAC Output</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      margin: 20px;
      display: flex;
      justify-content: space-between;
    }
    #table {
      width: 75%;
    }
    .summary-box {
      width: 23%;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 10px;
    }
    canvas {
      max-width: 100%;
    }
    .status-pass { color: green; font-weight: bold; }
    .status-warning { color: orange; font-weight: bold; }
    .status-fail { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div id="table"></div>

  <div class="summary-box">
    <canvas id="pieChart"></canvas>
    <div id="summary" style="margin-top: 20px;"></div>
  </div>

  <script>
    const tolerance = 2;
    const dates = ["01-Mar", "02-Mar", "04-Mar", "05-Mar", "06-Mar", "07-Mar", "08-Mar", "10-Mar", "11-Mar", "12-Mar", "13-Mar", "14-Mar", "15-Mar", "17-Mar", "18-Mar", "19-Mar", "20-Mar", "21-Mar"];
    const energies = ["6X", "10X", "15X", "6X FFF", "10X FFF", "6E", "9E", "12E", "15E", "18E"];

    const container = document.getElementById('table');
    const data = energies.map(energy => [energy, ...Array(dates.length).fill(null)]);

    const hot = new Handsontable(container, {
      data,
      colHeaders: ["Energy", ...dates],
      rowHeaders: true,
      licenseKey: 'non-commercial-and-evaluation',
      columns: [
        { readOnly: true },
        ...dates.map(() => ({ type: 'numeric', numericFormat: { pattern: '0.0' } }))
      ],
      stretchH: 'all',
      height: 'auto',
      afterChange: function (changes, source) {
        if (source === 'edit' || source === 'Autofill.fill') {
          updateSummary();
        }
      }
    });

    const ctx = document.getElementById('pieChart').getContext('2d');
    const pieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Within Tolerance', 'Warning', 'Out of Tolerance'],
        datasets: [{
          data: [0, 0, 0],
          backgroundColor: ['#9be7a7', '#ffe082', '#ff8a80'],
        }]
      }
    });

    function updateSummary() {
      let pass = 0, warn = 0, fail = 0;
      const updatedData = hot.getData();

      updatedData.forEach(row => {
        row.slice(1).forEach(val => {
          if (val === null || val === '') return;
          const absVal = Math.abs(parseFloat(val));
          if (absVal < tolerance) pass++;
          else if (absVal === tolerance) warn++;
          else fail++;
        });
      });

      pieChart.data.datasets[0].data = [pass, warn, fail];
      pieChart.update();

      const total = pass + warn + fail;
      document.getElementById('summary').innerHTML = `
        <h3>Summary</h3>
        <p><strong>Total Entries:</strong> ${total}</p>
        <p style="color: green;"><strong>✔ Within Tolerance:</strong> ${pass}</p>
        <p style="color: orange;"><strong>⚠ Warning:</strong> ${warn}</p>
        <p style="color: red;"><strong>✖ Out of Tolerance:</strong> ${fail}</p>
      `;
    }

    updateSummary();
  </script>
</body>
</html>
