<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINAC Output Entry</title>
  <link rel="icon" href="/favicon.png" type="image/png"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>


  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <style>
    /* CSS Variables for Colors */
    :root {
      --primary-blue: #007bff;
      --primary-blue-dark: #0056b3;
      --primary-blue-light: #e0f7fa;
      --text-dark: #333;
      --text-light: #fff;
      --background-light: #f5f5f5;
      --background-white-card: #ffffff;
      --background-dark-card: #333;
      --background-off-white: #f8f8f8;
      --border-light: #ccc;
      --border-darker: #aaa;
      --success-green: #28a745;
      --warning-orange: #ffc107;
      --error-red: #dc3545;
      --shadow-light: rgba(0,0,0,0.08);
      --shadow-medium: rgba(0,0,0,0.12);
      --shadow-strong: rgba(0,0,0,0.2);
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--background-light);
      color: var(--text-dark);
      display: flex;
      height: 100vh;
      overflow: hidden;
      flex-direction: column;
    }

    /* Global Micro-interaction */
    button, a.button, select {
      transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    button:hover, a.button:hover, select:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px var(--shadow-light);
    }
    button:active, a.button:active, select:active {
        transform: translateY(0);
        box-shadow: 0 1px 4px var(--shadow-light) inset;
    }

    /* Card/Panel Base Styling */
    .card-panel {
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08), 0 10px 30px rgba(0,0,0,0.12);
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.05);
      padding: 20px;
      box-sizing: border-box;
    }

    /* Topbar styling */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #ffffff;
      padding: 10px 20px;
      border-bottom: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      min-height: 50px;
    }
    .hospital-info-box {
        background-color: #e0f7fa;
        color: #0056b3;
        padding: 8px 15px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95em;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .topbar button {
      padding: 8px 15px;
      font-size: 14px;
      margin-left: 10px;
      margin-right: 0;
      color: #fff;
      border-radius: 6px;
    }
    .topbar button:first-of-type {
        background-color: #007bff;
    }
    .topbar button:first-of-type:hover {
        background-color: #0056b3;
    }
    .topbar button:last-of-type {
        background-color: #dc3545;
    }
    .topbar button:last-of-type:hover {
        background-color: #bb2d3b;
    }


    body.dark .topbar {
      background-color: #2a2a2a;
      border-color: #444;
    }
    body.dark .hospital-info-box {
        background-color: #0056b3;
        color: #e0f7fa;
        box-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }

    .content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .sidebar {
      width: 200px;
      background: #ffffff;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
    }
    .sidebar h2 {
        margin: 0 0 20px;
        color: #007bff;
        font-weight: 600;
        font-size: 1.5em;
    }
    .sidebar button {
      width: 100%;
      margin-bottom: 8px;
      padding: 10px 8px;
      background: #eee;
      color: #333;
      font-weight: 500;
      text-align: center;
      border-radius: 6px;
    }
    .sidebar button.active {
        background: #007bff;
        color: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .sidebar button:hover:not(.active) {
        background: #e0e0e0;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .sidebar label {
        display: flex;
        align-items: center;
        margin-top: 15px;
        font-size: 0.95em;
        color: #333;
    }
    .sidebar input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.2);
    }
    .sidebar p {
        font-size: 0.8em;
        margin-top: auto;
        color: #777;
    }


    .main {
      flex-grow: 1;
      padding: 20px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Month Header Box */
    .month-header-box {
        background: #007bff;
        color: #fff;
        padding: 15px 20px;
        text-align: center;
        font-size: 1.6em;
        font-weight: 600;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
      flex: 1;
    }
    #table {
        flex-grow: 1;
        height: 500px;
        min-width: 400px;
        /* Apply card-panel base styles */
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08), 0 10px 30px rgba(0,0,0,0.12);
        background: #ffffff;
        border: 1px solid rgba(0,0,0,0.05);
        overflow: hidden;
    }
    /* Handsontable specific overrides for cell background and text */
    #table .ht_master, #table .handsontable {
        background-color: #ffffff;
        color: #333;
    }
    #table .handsontable td, #table .handsontable th {
        border-color: #aaa;
    }
    /* Corrected: Use specific class for placeholder styling in dark mode */
    body.dark #table .handsontable .htPlaceholder {
        background-color: #2a2a2a !important;
    }

    .summary-box {
      width: 300px;
      min-width: 280px;
      padding: 20px;
      /* Apply card-panel base styles */
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08), 0 10px 30px rgba(0,0,0,0.12);
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.05);
    }
    .summary-box h3 {
        margin-top: 0;
        color: #007bff;
        font-weight: 600;
        font-size: 1.4em;
        margin-bottom: 15px;
    }
    .summary-box p {
        font-size: 1em;
        margin-bottom: 8px;
    }
    .summary-box span {
        font-weight: 500;
    }
    canvas {
        margin-bottom: 15px;
    }

    #save-section {
      margin-top: 0px;
      text-align: center;
    }
    #save-section button {
        padding: 10px 20px;
        font-size: 1em;
        font-weight: bold;
        background-color: #007bff;
        color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    #save-section button:hover {
        background-color: #0056b3;
        box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    }
    button:active, a.button:active, select:active {
        transform: translateY(0);
        box-shadow: 0 1px 4px rgba(0,0,0,0.08) inset;
    }


    .trend-chart-section {
        margin-top: 0px;
        padding: 20px;
        /* Apply card-panel base styles */
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08), 0 10px 30px rgba(0,0,0,0.12);
        background: #ffffff;
        border: 1px solid rgba(0,0,0,0.05);
    }
    .trend-chart-section h3 {
        margin-top: 0;
        color: #007bff;
        font-weight: 600;
        font-size: 1.4em;
        margin-bottom: 15px;
        text-align: center;
    }
    .trend-chart-section label {
        color: #333;
        font-weight: 500;
    }
    .trend-chart-section select {
        padding: 10px;
        border: 1px #ccc solid;
        background-color: #ffffff;
        color: #333;
        font-size: 0.95em;
        border-radius: 6px;
    }
    .trend-chart-section button {
        padding: 10px 20px;
        font-size: 0.95em;
        background-color: #007bff;
        color: #fff;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }


    /* Dark Mode overrides */
    body.dark {
      background-color: #1a1a1a;
      color: #fff;
    }
    body.dark .topbar, body.dark .sidebar, body.dark .summary-box, body.dark .trend-chart-section, #table, body.dark .login-container, body.dark .signup-container, body.dark .message-container, body.dark .card, body.dark .month-header-box {
        background: #2a2a2a;
        box-shadow: 0 0 15px rgba(0,0,0,0.6);
        border-color: #444;
    }
    body.dark .hospital-info-box {
        background-color: #0056b3;
        color: #e0f7fa;
        box-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    body.dark .topbar #hospitalName, body.dark h1, body.dark h2, body.dark h3, body.dark .user-info strong {
        color: #e0f7fa;
    }
    body.dark .sidebar button {
        background: #3a3a3a;
        color: #fff;
    }
    body.dark .sidebar button.active {
        background: #007bff;
    }
    body.dark .sidebar button:hover:not(.active) {
        background: #4a4a4a;
    }
    body.dark select, body.dark input {
        background-color: #3a3a3a;
        color: #fff;
        border-color: #555;
    }
    body.dark #table .ht_master, body.dark #table .handsontable {
        background-color: #2a2a2a;
        color: #fff;
    }
    body.dark #table .handsontable td, body.dark #table .handsontable th {
        border-color: #555;
    }
    /* Corrected: Using specific class for placeholder styling in dark mode */
    body.dark #table .handsontable .htPlaceholder {
        background-color: #2a2a2a !important;
    }
    body.dark .summary-box p, body.dark .sidebar label, body.dark .sidebar p, body.dark .trend-chart-section label {
        color: #bbb;
    }


    /* Loading Overlay & Spinner */
    #loading-overlay {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .spinner {
      width: 60px;
      height: 60px;
      border: 8px solid #ffffff;
      border-top-color: #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Handsontable Cell Coloring */
    .within { background-color: #d4edda !important; color: #155724 !important; }
    .warning { background-color: #fff3cd !important; color: #856404 !important; }
    .out { background-color: #f8d7da !important; color: #721c24 !important; }

    /* NEW CSS for Smooth Transitions */
    .data-container {
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        opacity: 1;
        transform: translateY(0);
    }

    .data-container.loading-transition {
        opacity: 0;
        transform: translateY(10px);
    }

    /* NEW CSS for Chatbot */
    #chat-bubble {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: var(--primary-blue);
        color: white;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.8em;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        z-index: 1000;
    }
    #chat-bubble:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }

    #chat-window {
        position: fixed;
        bottom: 90px; /* Above the bubble */
        right: 20px;
        width: 350px;
        height: 450px;
        background-color: var(--background-white-card);
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 999;
        transform: scale(0.8); /* Start smaller for transition */
        opacity: 0;
        visibility: hidden; /* Hidden by default */
        transition: transform 0.3s ease-out, opacity 0.3s ease-out, visibility 0.3s;
    }
    #chat-window.open {
        transform: scale(1);
        opacity: 1;
        visibility: visible;
    }

    #chat-header {
        background-color: var(--primary-blue);
        color: white;
        padding: 15px;
        font-size: 1.1em;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
    }
    #chat-header button {
        background: none;
        border: none;
        color: white;
        font-size: 1.2em;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
    }
    #chat-header button:hover {
        background-color: rgba(255,255,255,0.2);
    }

    #chat-body {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: var(--background-off-white);
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .chat-message {
        max-width: 80%;
        padding: 10px 12px;
        border-radius: 18px;
        line-height: 1.4;
        font-size: 0.95em;
        word-wrap: break-word;
    }
    .chat-message.user {
        align-self: flex-end;
        background-color: #e6e6e6;
        color: var(--text-dark);
        border-bottom-right-radius: 2px;
    }
    .chat-message.bot {
        align-self: flex-start;
        background-color: var(--primary-blue-light);
        color: var(--primary-blue-dark);
        border-bottom-left-radius: 2px;
    }
    body.dark #chat-window {
        background-color: #2a2a2a;
    }
    body.dark #chat-body {
        background-color: #3a3a3a;
        color: #fff;
    }
    body.dark .chat-message.user {
        background-color: #555;
        color: #eee;
    }
    body.dark .chat-message.bot {
        background-color: var(--primary-blue-dark);
        color: var(--primary-blue-light);
    }


    #chat-input-area {
        padding: 10px 15px;
        border-top: 1px solid var(--border-light);
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #chat-input-area input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid var(--border-light);
        border-radius: 20px;
        font-size: 0.95em;
        background-color: var(--background-white-card);
        color: var(--text-dark);
    }
    body.dark #chat-input-area input {
        background-color: #4a4a4a;
        border-color: #666;
        color: #eee;
    }
    #chat-input-area button {
        background-color: var(--primary-blue);
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 1.2em;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    #chat-input-area button:hover {
        background-color: var(--primary-blue-dark);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div id="hospitalInfoBox" class="hospital-info-box">
        <span id="hospitalName">Hospital: </span>
    </div>
    <span style="flex-grow: 1;"></span>
    <button id="myProfileBtn"
            style="background-color: var(--primary-blue); color: var(--text-light);">
      My Profile
    </button>
    <button id="logoutBtn"
            style="background-color: var(--error-red); color: var(--text-light);">
      Logout
    </button>
  </div>

  <div class="content">
    <div class="sidebar">
      <h2>LINAC QA</h2>
      <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 10px;">
        <button id="prevYearBtn">←</button>
        <span id="year" style="margin: 0 10px;">2025</span>
        <button id="nextYearBtn">→</button>
      </div>
      <div id="months"></div>
      <label><input type="checkbox" id="darkToggle"> Dark Mode</label>
      <p style="font-size:12px;margin-top:auto;">© 2025 QA Dashboard</p>
    </div>

    <div class="main">
      <div class="month-header-box" id="header">
        </div>
      <div class="container">
        <div id="table" class="data-container"></div>
        <div class="summary-box data-container">
          <canvas id="summaryChart" width="280" height="280"></canvas>
          <h3>Summary</h3>
          <p><strong>Total Entries:</strong> <span id="total">0</span></p>
          <p style="color:var(--success-green);">✓ <strong>Within Tolerance:</strong> <span id="within">0</span></p>
          <p style="color:var(--warning-orange);">⚠ <strong>Warning:</strong> <span id="warning">0</span></p>
          <p style="color:var(--error-red);">✗ <strong>Out of Tolerance:</strong> <span id="out">0</span></p>
        </div>
      </div>
      <div id="save-section">
        <button id="saveBtn" style="font-weight:bold; background-color: var(--primary-blue); color: var(--text-light);">
            <i class="fas fa-save"></i> Save
        </button>
        <span id="lastSaved" style="margin-left:15px;font-size:14px;color:gray;"></span>
      </div>
      <div class="trend-chart-section data-container" style="margin-top: 30px;">
        <h3>Energy Trend Analysis (Current Month)</h3>
        <div style="margin-bottom: 15px;">
          <label for="trendEnergySelect" style="font-weight: bold; margin-right: 10px;">Select Energy Type:</label>
          <select id="trendEnergySelect" style="padding: 8px; border: 1px var(--border-light) solid;">
            </select>
          <button id="showTrendBtn" style="background-color: var(--primary-blue); color: var(--text-light); margin-left: 10px;">
              <i class="fas fa-chart-line"></i> Show Trend
          </button>
        </div>
        <canvas id="trendChart" style="max-height: 350px; width: 100%;"></canvas>
      </div>
    </div>
  </div>

  <div id="loading-overlay"><div class="spinner"></div></div>

  <div id="chat-bubble"><i class="fas fa-comment-dots"></i></div>
  <div id="chat-window">
      <div id="chat-header">
          <span>QA Bot</span>
          <button id="close-chat-btn"><i class="fas fa-times"></i></button>
      </div>
      <div id="chat-body">
          <div class="chat-message bot">Hello! How can I help you with your QA data today?</div>
          <div class="chat-message bot">You can ask: "Out of tolerance dates"</div>
      </div>
      <div id="chat-input-area">
          <input type="text" id="chat-input" placeholder="Type your question...">
          <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
      </div>
  </div>


  <script>
    // Firebase config
    var firebaseConfig = {
      apiKey: "AIzaSyBtG_xKqhJZFXmEvJ-Y0uqTG3WurrDSRgE",
      authDomain: "linac-qa-project.firebaseapp.com",
      projectId: "linac-qa-project",
      storageBucket: "linac-qa-project.appspot.com",
      messagingSenderId: "850988733382",
      appId: "1:395443876940:web:8ed5b7b3d17693bd70b31c", // Ensure this appId is correct. Check Firebase console for your actual project.
      measurementId: "G-HFJ2CGS664"
    };

    // Initialize Firebase (Using Compat SDK's global 'firebase' object)
    firebase.initializeApp(firebaseConfig);
    var auth = firebase.auth();
    var db = firebase.firestore();

    var currentUID, currentHospital;

    // Declare global variables that will hold Handsontable and Chart.js instances
    var hot, summaryChart, trendChart;

    // Get references to DOM elements using their IDs
    var container = document.getElementById('table');
    var monthsDiv = document.getElementById('months');
    var header = document.getElementById('header');
    var yearLabel = document.getElementById('year');
    var lastSaved = document.getElementById('lastSaved');
    var darkToggle = document.getElementById('darkToggle');
    var saveBtn = document.getElementById('saveBtn');
    var logoutBtn = document.getElementById('logoutBtn');
    var myProfileBtn = document.getElementById('myProfileBtn');
    var prevYearBtn = document.getElementById('prevYearBtn');
    var nextYearBtn = document.getElementById('nextYearBtn');
    var showTrendBtn = document.getElementById('showTrendBtn');

    // Get references for data containers to apply transitions
    var tableContainer = document.getElementById('table');
    var summaryBox = document.querySelector('.summary-box');
    var trendChartSection = document.querySelector('.trend-chart-section');

    // NEW Chatbot UI element references
    var chatBubble = document.getElementById('chat-bubble');
    var chatWindow = document.getElementById('chat-window');
    var closeChatBtn = document.getElementById('close-chat-btn');
    var chatBody = document.getElementById('chat-body');
    var chatInput = document.getElementById('chat-input');
    var sendChatBtn = document.getElementById('send-chat-btn');


    var currentDate = new Date(); currentDate.setDate(1);
    var energyTypes = ["6X","10X","15X","6X FFF","10X FFF","6E","9E","12E","15E","18E"];

    var outOfToleranceValues = []; // This array holds the current out-of-tolerance values displayed in the table.

    // --- Core Functions ---
    window.logout = function() {
      showLoader();
      auth.signOut().then(() => {
        localStorage.clear();
        hideLoader();
        window.location.href = "login.html";
      }).catch((error) => {
        console.error("Logout error:", error);
        hideLoader();
        alert("Logout failed: " + error.message);
      });
    }

    function getMonthDates(date) {
      var y = date.getFullYear(), m = date.getMonth();
      var days = new Date(y, m + 1, 0).getDate();
      return Array.from({ length: days }, (_, i) => `${y}-${String(m + 1).padStart(2, '0')}-${String(i+1).padStart(2, '0')}`);
    }

    function generateEmptyData(dates) {
      return energyTypes.map(e => [e, ...new Array(dates.length).fill('')]);
    }

    function showLoader(){document.getElementById('loading-overlay').style.display='flex';}
    function hideLoader(){document.getElementById('loading-overlay').style.display='none';}

    async function loadTable() {
      showLoader();
      if (tableContainer) tableContainer.classList.add('loading-transition');
      if (summaryBox) summaryBox.classList.add('loading-transition');

      var dateCols = getMonthDates(currentDate);
      document.getElementById('header').textContent = `${currentDate.toLocaleString('default',{month:'long'})} ${currentDate.getFullYear()}`;
      yearLabel.textContent = currentDate.getFullYear();
      highlightActiveMonth();

      var monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
      try {
        var res = await fetch(`https://back-end-wrxi.onrender.com/data?month=${monthKey}&uid=${currentUID}`);
        var result = await res.json();
        var data = Array.isArray(result.data) && result.data.length === energyTypes.length
          ? result.data.map(r=>r.map(c=> c===null||c==="None"?"":c))
          : generateEmptyData(dateCols);

        if (hot) hot.destroy();
        hot = new Handsontable(container, {
          data,
          rowHeaders: false,
          stretchH: 'all',
          height: 500,
          licenseKey: 'non-commercial-and-evaluation',
          colHeaders: i => i === 0 ? 'Energy' : dateCols[i - 1] || '',
          columns: Array(dateCols.length + 1).fill({ type: 'text' }),
          afterChange: (changes, source) => {
            if (!changes || source === 'loadData') return;
            updateSummaryAndChart(hot.getData());
          },
          cells: function (r, c) {
            var props = {};
            if (c === 0) return props;
            var v = parseFloat(this.instance.getDataAtCell(r, c));
            if (!isNaN(v)) {
              props.className = Math.abs(v) <= 1.8 ? 'within' : (Math.abs(v) <= 2 ? 'warning' : 'out');
            }
            return props;
          }
        });

        updateSummaryAndChart(data);
      } catch(e) {
        console.error("Error loading table data:", e);
        alert("Could not load table data. Please try again.");
      } finally {
        hideLoader();
        if (tableContainer) tableContainer.classList.remove('loading-transition');
        if (summaryBox) summaryBox.classList.remove('loading-transition');
      }
    }

    function updateSummaryAndChart(data) {
      var total=0, within=0, warning=0, out=0;
      outOfToleranceValues = [];

      var dateCols = getMonthDates(currentDate);

      data.forEach((row, rowIndex) => {
        var energyType = row[0];
        row.slice(1).forEach((value, colIndex) => {
          var n = parseFloat(value);
          if(!isNaN(n)){
            total++;
            if(Math.abs(n)<=1.8) {
                within++;
            } else if(Math.abs(n)<=2) {
                warning++;
            } else {
                out++;
                outOfToleranceValues.push({
                    energy: energyType,
                    date: dateCols[colIndex],
                    value: n
                });
            }
          }
        });
      });
      document.getElementById("total").textContent = total;
      document.getElementById("within").textContent = within;
      document.getElementById("warning").textContent = warning;
      document.getElementById("out").textContent = out;

      var ctx = document.getElementById('summaryChart').getContext('2d');
      if (summaryChart) summaryChart.destroy();
      summaryChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Within Tolerance','Warning','Out of Tolerance'],
          datasets: [{ data: [within,warning,out], backgroundColor: ['#66cc66','#ffcc00','#ff6666'] }]
        }
      });
    }

    async function manualSave() {
      showLoader();
      var changedData = hot.getData();
      var month = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
      try {
        var saveResponse = await fetch('https://back-end-wrxi.onrender.com/save',{
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ data: changedData, month, uid: currentUID })
        });

        if (!saveResponse.ok) {
            throw new Error('Failed to save data: ' + saveResponse.statusText);
        }

        lastSaved.textContent = "Last Saved: " + new Date().toLocaleString();
        alert("Data saved successfully!");

        if (outOfToleranceValues.length > 0 || lastSaved.textContent !== '') {
            var alertResponse = await fetch('https://back-end-wrxi.onrender.com/send-alert', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    outValues: outOfToleranceValues,
                    hospitalName: currentHospital,
                    uid: currentUID,
                    month: month
                })
            });

            var alertResult = await alertResponse.json();
            if (alertResult.status === 'alert sent') {
                console.log("Email alert sent for current out of tolerance values.");
            } else if (alertResult.status === 'no_change') {
                console.log("No new out-of-tolerance values or changes. Email not sent.");
            } else {
                console.warn("Could not send email alert:", alertResult.message || alertResult.status);
                alert("Alert email could not be sent: " + (alertResult.message || "Unknown error."));
            }
        } else {
            console.log("No out-of-tolerance values to send for alert and no prior save to trigger a resolution check.");
        }

      } catch(err){
        console.error("Operation failed:", err);
        alert("Operation failed: " + err.message);
      } finally{
        hideLoader();
      }
    }

    function changeMonth(m){ currentDate = new Date(currentDate.getFullYear(), m, 1); loadTable(); updateTrendChart(); }
    function changeYear(o){ currentDate = new Date(currentDate.getFullYear()+o, currentDate.getMonth(), 1); loadTable(); updateTrendChart(); }
    function toggleDarkMode(){ document.body.classList.toggle('dark'); }

    function buildMonthButtons(){
      var months=['January','February','March','April','May','June','July','August','September','October','November','December'];
      monthsDiv.innerHTML='';
      months.forEach((m,i)=>{
        var btn = document.createElement('button');
        btn.textContent = m;
        btn.addEventListener('click', () => changeMonth(i));
        monthsDiv.appendChild(btn);
      });
      highlightActiveMonth();
    }

    function highlightActiveMonth(){
      [...monthsDiv.querySelectorAll('button')].forEach((btn,i)=>{
        btn.classList.toggle('active', i === currentDate.getMonth());
      });
    }

    function populateTrendEnergySelect() {
        var select = document.getElementById('trendEnergySelect');
        select.innerHTML = '';
        energyTypes.forEach(energy => {
            var option = document.createElement('option');
            option.value = energy;
            option.textContent = energy;
            select.appendChild(option);
        });
        if (energyTypes.length > 0) {
            select.value = energyTypes[0];
            updateTrendChart();
        }
    }

    async function updateTrendChart() {
        showLoader();
        if (trendChartSection) trendChartSection.classList.add('loading-transition');

        var selectedEnergy = document.getElementById('trendEnergySelect').value;
        if (!selectedEnergy) {
            hideLoader();
            alert("Please select an energy type for trend analysis.");
            if (trendChartSection) trendChartSection.classList.remove('loading-transition');
            return;
        }

        var dataPoints = [];
        var labels = [];
        var currentYear = currentDate.getFullYear();
        var currentMonth = currentDate.getMonth() + 1;

        var daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

        var monthKey = `${currentYear}-${String(currentMonth).padStart(2,'0')}`;
        try {
            var res = await fetch(`https://back-end-wrxi.onrender.com/data?month=${monthKey}&uid=${currentUID}`);
            var result = await res.json();
            var monthData = result.data;

            var energyRow = monthData.find(row => row[0] === selectedEnergy);

            if (energyRow) {
                for (let i = 0; i < daysInMonth; i++) {
                    var value = energyRow[i + 1];
                    var n = parseFloat(value);
                    dataPoints.push(isNaN(n) ? null : n);
                    labels.push(String(i + 1).padStart(2, '0'));
                }
            } else {
                for (let i = 0; i < daysInMonth; i++) {
                    dataPoints.push(null);
                    labels.push(String(i + 1).padStart(2, '0'));
                }
            }

            var ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${selectedEnergy} Output Trend (${currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })})`,
                        data: dataPoints,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        fill: false,
                        tension: 0.1,
                        spanGaps: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Output Value (%)'
                            },
                            min: -3,
                            max: 3,
                            ticks: {
                                callback: function(value, index, values) {
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Day of Month'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + (context.parsed.y !== null ? context.parsed.y.toFixed(2) + '%' : 'No Data');
                                }
                            }
                        }
                    }
                }
            });

        } catch (error) {
            console.error("Error fetching trend data:", error);
            alert("Could not load trend data. Please try again.");
        } finally {
            hideLoader();
            if (trendChartSection) trendChartSection.classList.remove('loading-transition');
        }
    }

    // NEW: Function to add message to chat window
    function addChatMessage(message, sender) {
        var messageElement = document.createElement('div');
        messageElement.classList.add('chat-message', sender);
        messageElement.textContent = message;
        chatBody.appendChild(messageElement);
        chatBody.scrollTop = chatBody.scrollHeight; // Scroll to bottom
    }

    // NEW: Function to handle sending chat messages
    async function sendChatMessage() {
        var message = chatInput.value.trim();
        if (message === "") return;

        addChatMessage(message, 'user');
        chatInput.value = ''; // Clear input

        // Convert message to lowercase for easier matching
        var lowerCaseMessage = message.toLowerCase();
        var botResponse = ""; // Initialize botResponse here

        // --- NEW: Basic Greetings and Conversational Responses ---
        if (lowerCaseMessage.includes('hi') || lowerCaseMessage.includes('hello') || lowerCaseMessage.includes('hey')) {
            botResponse = "Hello there! How can I assist you with your QA data today? You can ask: 'Out of tolerance dates', 'value for 6X on 2025-06-10', 'show me all 6X data for this month', or 'list all warning values'.";
        } else if (lowerCaseMessage.includes('how are you')) {
            botResponse = "I'm just a bot, but I'm doing great! How can I help you manage your LINAC QA?";
        } else if (lowerCaseMessage.includes('thank you') || lowerCaseMessage.includes('thanks')) {
            botResponse = "You're welcome! Happy to help.";
        }
        // --- End NEW Basic Responses ---

        // If a basic response was generated, display it and stop.
        if (botResponse !== "") {
            addChatMessage(botResponse, 'bot');
            return;
        }

        // --- Extract Energy Type and Date (for data queries) ---
        var energyMatch = lowerCaseMessage.match(/(6X|10X|15X|6X FFF|10X FFF|6E|9E|12E|15E|18E)/i);
        var dateMatch = lowerCaseMessage.match(/(\d{4}-\d{2}-\d{2})/); //YYYY-MM-DD format

        var extractedEnergyType = energyMatch ? energyMatch[0].toUpperCase() : null;
        var extractedDate = dateMatch ? dateMatch[0] : null;
        
        var monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;

        // --- Data Query Logic ---
        if (lowerCaseMessage.includes('out of tolerance dates')) {
            addChatMessage("Finding out of tolerance dates for current month...", 'bot');
            try {
                var response = await fetch('https://back-end-wrxi.onrender.com/query-qa-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: 'out_of_tolerance_dates',
                        month: monthKey,
                        uid: currentUID
                    })
                });
                var result = await response.json();
                if (result.status === 'success') {
                    if (result.dates && result.dates.length > 0) {
                        botResponse = "The following dates had data beyond tolerance levels: " + result.dates.join(', ');
                    } else {
                        botResponse = "Great news! No data went beyond tolerance levels this month.";
                    }
                } else {
                    botResponse = "Sorry, I couldn't retrieve that information: " + (result.message || "Unknown error.");
                }
            } catch (error) {
                console.error("Chatbot query error:", error);
                botResponse = "Oops! Something went wrong while trying to get that information. Please try again later.";
            }
        }
        // "What is the value/status for [Energy Type] on [Date]?"
        else if ((lowerCaseMessage.includes('what is the value for') || lowerCaseMessage.includes('what is the status for')) && extractedEnergyType && extractedDate) {
            addChatMessage(`Looking up data for ${extractedEnergyType} on ${extractedDate}...`, 'bot');
            try {
                var response = await fetch('https://back-end-wrxi.onrender.com/query-qa-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: 'value_on_date',
                        month: monthKey,
                        uid: currentUID,
                        energy_type: extractedEnergyType,
                        date: extractedDate
                    })
                });
                var result = await response.json();
                if (result.status === 'success') {
                    if (result.value !== undefined && result.value !== null) {
                        botResponse = `For ${result.energy_type} on ${result.date}: Value is ${result.value}% (Status: ${result.data_status}).`;
                    } else {
                        botResponse = `No data found for ${extractedEnergyType} on ${extractedDate}.`;
                    }
                } else {
                    botResponse = `Sorry, I couldn't retrieve that information: ${result.message || "Unknown error."}`;
                }
            } catch (error) {
                console.error("Chatbot query error:", error);
                botResponse = "Oops! Something went wrong while trying to get that information. Please try again later.";
            }
        }
        // "Show me all [Energy Type] data for this month."
        else if (lowerCaseMessage.includes('show me all') && extractedEnergyType && lowerCaseMessage.includes('data for this month')) {
            addChatMessage(`Getting all data for ${extractedEnergyType} this month...`, 'bot');
            try {
                var response = await fetch('https://back-end-wrxi.onrender.com/query-qa-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: 'energy_data_for_month',
                        month: monthKey,
                        uid: currentUID,
                        energy_type: extractedEnergyType
                    })
                });
                var result = await response.json();
                if (result.status === 'success' && result.data && result.data.length > 0) {
                    let formattedData = result.data.map(item => `${item.date}: ${item.value}%`).join(', ');
                    botResponse = `Here is the data for ${extractedEnergyType} this month: ${formattedData}.`;
                } else {
                    botResponse = result.message || `No data found for ${extractedEnergyType} this month.`;
                }
            } catch (error) {
                console.error("Chatbot query error:", error);
                botResponse = "Oops! Something went wrong while trying to get that information. Please try again later.";
            }
        }
        // "List all warning values for [specific month]."
        else if (lowerCaseMessage.includes('list all warning values') || lowerCaseMessage.includes('show warning values')) {
            addChatMessage(`Getting warning values for this month...`, 'bot');
            try {
                var response = await fetch('https://back-end-wrxi.onrender.com/query-qa-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: 'warning_values_for_month',
                        month: monthKey,
                        uid: currentUID
                    })
                });
                var result = await response.json();
                if (result.status === 'success' && result.warning_entries && result.warning_entries.length > 0) {
                    let formattedWarnings = result.warning_entries.map(item => `${item.energy} on ${item.date}: ${item.value}%`).join('; ');
                    botResponse = `Warning values this month: ${formattedWarnings}.`;
                } else {
                    botResponse = "No warning values found this month. Great job!";
                }
            } catch (error) {
                console.error("Chatbot query error:", error);
                botResponse = "Oops! Something went wrong while trying to get that information. Please try again later.";
            }
        }
        // --- Fallback for unrecognized commands ---
        else {
             botResponse = "I'm sorry, I don't understand that request. Please try rephrasing or ask about 'Out of tolerance dates', 'value for 6X on 2025-06-10', 'show me all 6X data for this month', or 'list all warning values'.";
        }
        
        addChatMessage(botResponse, 'bot');
    }


    // Attach all event listeners after the DOM is fully loaded and all functions are defined.
    document.addEventListener('DOMContentLoaded', function() {
        // Event listeners for static buttons
        saveBtn.addEventListener('click', manualSave);
        logoutBtn.addEventListener('click', window.logout);
        myProfileBtn.addEventListener('click', function() { window.location.href='my_profile.html'; });
        darkToggle.addEventListener('change', toggleDarkMode);
        prevYearBtn.addEventListener('click', function() { changeYear(-1); });
        nextYearBtn.addEventListener('click', function() { changeYear(1); });
        showTrendBtn.addEventListener('click', updateTrendChart);

        // NEW Chatbot Event Listeners
        chatBubble.addEventListener('click', function() {
            chatWindow.classList.toggle('open');
            if (chatWindow.classList.contains('open')) {
                chatInput.focus(); // Focus input when opened
            }
        });
        closeChatBtn.addEventListener('click', function() {
            chatWindow.classList.remove('open');
        });
        sendChatBtn.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });


        // Firebase Auth State Listener - this should be the last logical step to kick off loading
        auth.onAuthStateChanged(function(user) {
            if (user) {
                currentUID = user.uid;
                currentHospital = localStorage.getItem("hospitalName") || (user.email?.split('@')[0] ?? 'UNKNOWN').toUpperCase();
                var userStatus = localStorage.getItem("userStatus");

                if (userStatus === 'pending' || userStatus === 'rejected' || userStatus === 'unknown') {
                    alert("Your account status is: " + userStatus.toUpperCase() + ". Please await admin approval or contact support.");
                    window.logout();
                    return;
                }

                localStorage.setItem("uid", currentUID);
                document.getElementById("hospitalName").textContent = "Hospital: " + currentHospital;
                buildMonthButtons();
                loadTable();
                populateTrendEnergySelect();
            } else {
                window.location.href = "login.html";
            }
        });
    });

  </script>
</body>
</html>
