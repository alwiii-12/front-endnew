<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINAC Output Entry</title>
  <link rel="icon" href="/favicon.png" type="image/png">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css" />
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <style>
    /* This inline style block restores the original layout and applies the new fixes */
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #f5f5f5;
      color: #333;
      display: flex;
      height: 100vh;
      overflow: hidden;
      flex-direction: column;
    }
    .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #ffffff;
        padding: 10px 20px;
        border-bottom: 1px solid #ccc;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .hospital-info-box {
        background-color: #e0f7fa;
        color: #0056b3;
        padding: 8px 15px;
        border-radius: 8px;
        font-weight: 600;
    }
    .topbar .header-buttons {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .topbar .header-buttons .button, .topbar .header-buttons .header-btn {
        padding: 10px 18px;
        font-size: 1em;
    }
    .topbar .header-buttons .header-btn {
        width: 44px;
        height: 44px;
    }
    .topbar .header-buttons #myProfileBtn {
        background-color: var(--primary-color);
        color: var(--text-white);
    }

    .content {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    .sidebar {
        width: 200px;
        background: #ffffff;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column;
    }
    .sidebar h2 {
        margin: 0 0 20px;
        color: #007bff;
        text-align: center;
    }
    #months {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    #months button {
        width: 100%;
        padding: 12px 0;
        font-size: 1em;
    }

    .main {
        flex-grow: 1;
        padding: 20px;
        overflow: auto; /* This line fixes the layout issue */
    }
    .tab-nav {
        display: flex;
        border-bottom: 2px solid #ccc;
        margin-bottom: 20px;
    }
    .tab-nav-button {
        padding: 10px 20px;
        background-color: transparent;
        border: none;
        cursor: pointer;
        font-size: 1em;
    }
    .tab-nav-button.active {
        border-bottom: 3px solid #007bff;
        font-weight: bold;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .container {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        flex-wrap: wrap;
    }
    .table-container {
        flex-grow: 1;
        height: 500px;
    }
    .summary-box {
        width: 300px;
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        background-color: var(--bg-card);
        box-shadow: 0 4px 12px var(--shadow-light);
    }
    .actions-section, .trend-chart-section {
        text-align: center;
        margin-top: 20px;
    }
    .actions-section button {
        padding: 10px 15px;
        margin: 0 5px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        color: white;
    }
    .save-btn { background-color: #007bff; }
    .export-btn { background-color: #28a745; }
    
    .chart-wrapper {
        position: relative;
        height: 40vh;
        width: 100%;
    }
    .energy-selector-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 15px;
    }
    .energy-selector-container select {
        max-width: 250px;
        margin: 0;
    }

    #chat-bubble {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .trend-chart-section {
        position: relative; /* Needed for diagnose button */
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        background-color: var(--bg-card);
        box-shadow: 0 4px 12px var(--shadow-light);
    }
    #annotationModal .modal-buttons button {
        padding: 12px 25px;
        font-size: 1em;
    }
    #annotationModal textarea {
        width: 100%;
        min-height: 120px;
        resize: vertical;
    }
    #deleteAnnotationBtn {
        background-color: var(--status-error);
    }

    /* --- Styles for Diagnostics Feature & Blinking Animation --- */
    .diagnose-btn, .validate-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        color: var(--text-main);
        padding: 8px 12px;
        font-size: 0.9em;
        border-radius: 6px;
        z-index: 10;
        border: none;
        cursor: pointer;
    }
    .diagnose-btn { background-color: var(--status-warning); }
    .validate-btn { background-color: #17a2b8; color: white; }
    
    .diagnose-btn:hover { background-color: #ffca2c; }
    .validate-btn:hover { background-color: #138496; }

    .blinking-btn {
        animation: blink-animation 1.5s infinite;
    }
    @keyframes blink-animation {
        0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
        50% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
    }

    #chat-options-area {
        display: none; /* Hidden by default */
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px 15px;
        border-top: 1px solid var(--border-color);
    }
    .chat-option-btn {
        flex-grow: 1;
        background-color: var(--primary-light);
        color: var(--primary-dark);
        padding: 10px;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
    }
    .chat-option-btn:hover {
        background-color: var(--primary-color);
        color: var(--text-white);
    }
    .service-day-checkbox {
        margin-top: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-weight: 600;
        color: var(--primary-dark);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div id="hospitalInfoBox" class="hospital-info-box">Hospital: <span id="hospitalName"></span></div>
    <div class="header-buttons">
        <a href="my_profile.html" id="myProfileBtn" class="button">My Profile</a>
        <button id="logoutBtn" title="Logout" aria-label="Logout" class="header-btn" style="background-color: var(--status-error); color: white;"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </div>
  <div class="content">
    <div class="sidebar">
      <h2>LINAC QA</h2>
     <div class="year-nav">
        <button id="prevYearBtn" aria-label="Previous Year">&lt;</button>
        <span id="year">2025</span>
        <button id="nextYearBtn" aria-label="Next Year">&gt;</button>
    </div>
      <div id="months"></div>
      <label style="margin-top: auto; padding-top: 20px;"><input type="checkbox" id="darkToggle"> Dark Mode</label>
      <p>Â© 2025 QA Dashboard</p>
    </div>
    <div class="main">
      <h1 id="header" style="text-align: center;"></h1>
      <div class="tab-nav">
        <button class="tab-nav-button active" onclick="switchTab('output')">Output</button>
        <button class="tab-nav-button" onclick="switchTab('flatness')">Flatness</button>
        <button class="tab-nav-button" onclick="switchTab('inline')">Inline Symmetry</button>
        <button class="tab-nav-button" onclick="switchTab('crossline')">Crossline Symmetry</button>
      </div>
      <div id="tab-content-output" class="tab-content active"></div>
      <div id="tab-content-flatness" class="tab-content"></div>
      <div id="tab-content-inline" class="tab-content"></div>
      <div id="tab-content-crossline" class="tab-content"></div>
    </div>
  </div>
  <div id="loading-overlay"><div class="spinner"></div></div>
  <div id="chat-bubble"><i class="fas fa-comment-dots"></i></div>
  <div id="chat-window">
    <div id="chat-header"><span>QA Copilot</span><button id="close-chat-btn">&times;</button></div>
    <div id="chat-body"><div class="chat-message bot">Hello! Ask me about your data.</div></div>
    <div id="chat-input-area"><input type="text" id="chat-input" placeholder="Type..."><button id="send-chat-btn">&gt;</button></div>
    <div id="chat-options-area"></div>
  </div>

  <div id="annotationModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="hideAnnotationModal()">&times;</span>
        <h3 id="annotationModalTitle">Add/Edit Annotation</h3>
        <textarea id="annotationInput" placeholder="Enter your note here..."></textarea>
        <div class="service-day-checkbox">
            <input type="checkbox" id="isServiceDayInput">
            <label for="isServiceDayInput">Mark as Service/Calibration Day</label>
        </div>
        <div class="modal-buttons">
            <button id="deleteAnnotationBtn" class="button" style="display: none;">Delete Note</button>
            <button id="saveAnnotationBtn" class="save-btn">Save Note</button>
            <button class="cancel-btn" onclick="hideAnnotationModal()">Cancel</button>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-check-compat.js"></script>
  <script src="firebase-init.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appCheck = firebase.appCheck();
        const BACKEND_URL = "https://back-end-wrxi.onrender.com";
        let currentUID, currentHospital;
        let currentDate = new Date();
        currentDate.setDate(1);
        let lastDataMonth = null; // [NEW] Variable to store the last month with data

        const energyTypes = ["6X", "10X", "15X", "6X FFF", "10X FFF", "6E", "9E", "12E", "15E", "18E"];
        const dataTypesConfig = {
          output: { label: 'Output', tolerance: 2.0, warning: 1.8, initialized: false, yAxisMin: -3, yAxisMax: 3, diagnosticKeyword: 'output drift' },
          flatness: { label: 'Flatness', tolerance: 1.0, warning: 0.9, initialized: false, yAxisMin: -2, yAxisMax: 2, diagnosticKeyword: 'flatness warning' },
          inline: { label: 'Inline Symmetry', tolerance: 1.0, warning: 0.9, initialized: false, yAxisMin: -2, yAxisMax: 2, diagnosticKeyword: 'flatness warning' },
          crossline: { label: 'Crossline Symmetry', tolerance: 1.0, warning: 0.9, initialized: false, yAxisMin: -2, yAxisMax: 2, diagnosticKeyword: 'flatness warning' }
        };
        let instances = { output: {}, flatness: {}, inline: {}, crossline: {} };
        let activeTab = 'output';
        const yearLabel = document.getElementById('year');
        const monthsDiv = document.getElementById('months');
        const header = document.getElementById('header');
        
        // ... (other variable declarations remain the same)
        const annotationModal = document.getElementById('annotationModal');
        const annotationModalTitle = document.getElementById('annotationModalTitle');
        const annotationInput = document.getElementById('annotationInput');
        const saveAnnotationBtn = document.getElementById('saveAnnotationBtn');
        const deleteAnnotationBtn = document.getElementById('deleteAnnotationBtn');
        const isServiceDayInput = document.getElementById('isServiceDayInput');
        let currentAnnotationKey = null;

        let diagnosticState = { inProgress: false, topic: null, node_id: null };
        const chatInputArea = document.getElementById('chat-input-area');
        const chatOptionsArea = document.getElementById('chat-options-area');
        const chatBody = document.getElementById('chat-body');
        const chatInput = document.getElementById('chat-input');


        function showLoader() { document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loading-overlay').style.display = 'none'; }
        
        function logout() {
          showLoader();
          auth.signOut().then(() => {
            localStorage.clear();
            window.location.replace("login.html");
          }).catch(err => {
            hideLoader();
          });
        }

        async function checkForAlerts(dataType, data) {
            // ... (this function remains the same)
        }

        function generateTabContentHTML(dataType) {
            const config = dataTypesConfig[dataType];
            return `
                <div class="container">
                    <div id="table-${dataType}" class="table-container"></div>
                    <div class="summary-box">
                        <h3>${config.label} Summary</h3>
                        <canvas id="summaryChart-${dataType}"></canvas>
                        <p>Total Entries: <span id="total-${dataType}">0</span></p>
                        <p>Within Tolerance: <span id="within-${dataType}">0</span></p>
                        <p>Warning: <span id="warning-${dataType}">0</span></p>
                        <p>Out of Tolerance: <span id="out-${dataType}">0</span></p>
                    </div>
                </div>
                <div class="actions-section">
                    <button class="save-btn" onclick="manualSave('${dataType}')">Save ${config.label}</button>
                    <button class="export-btn" onclick="exportToExcel('${dataType}')">Export ${config.label}</button>
                    <span id="lastSaved-${dataType}"></span>
                </div>
                <div class="trend-chart-section" id="trend-section-${dataType}">
                    <h3>${config.label} Trend Analysis</h3>
                    <div class="energy-selector-container">
                        <label>Select Energy:</label>
                        <select id="trendEnergySelect-${dataType}" onchange="updateTrendChart('${dataType}')"></select>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="trendChart-${dataType}"></canvas>
                    </div>
                </div>
            `;
        }

        window.switchTab = async function(dataType) {
            // ... (this function remains the same)
        }

        async function initializeTab(dataType) {
            // ... (this function remains the same)
        }

        async function loadDataForTab(dataType) {
            // ... (this function remains largely the same)
        }

        // [NEW] Entirely new function for the "Validate Prediction" button
        window.validatePrediction = async function(dataType) {
            showLoader();
            const selectedEnergy = document.getElementById(`trendEnergySelect-${dataType}`).value;
            const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            
            try {
                const appCheckTokenResponse = await appCheck.getToken(false);
                const response = await fetch(`${BACKEND_URL}/historical-forecast`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Firebase-AppCheck': appCheckTokenResponse.token },
                    body: JSON.stringify({
                        uid: currentUID,
                        month: monthKey,
                        dataType: dataType,
                        energy: selectedEnergy
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to generate historical forecast.');
                }

                const result = await response.json();
                
                // We need to redraw the chart with the new data
                // Get existing chart instance and its data
                const chart = instances[dataType].trendChart;
                if (!chart) return;
                
                const historicalData = chart.data.datasets[0].data; // The blue line
                const lastHistoricalIndex = historicalData.map((y, i) => ({y, i})).filter(p => p.y !== null).pop()?.i ?? -1;
                
                // Create the new datasets for forecast and actuals
                const forecastLine = new Array(lastHistoricalIndex + 1).fill(null);
                forecastLine.push(...result.forecast.map(p => p.yhat));
                
                const actualsLine = new Array(lastHistoricalIndex + 1).fill(null);
                actualsLine.push(...result.actuals);

                chart.data.datasets.push({
                    label: 'Historical Forecast',
                    data: forecastLine,
                    borderColor: 'rgba(255, 99, 132, 1)', // Pink
                    borderDash: [5, 5],
                    tension: 0.1,
                });

                chart.data.datasets.push({
                    label: 'Next Month Actuals',
                    data: actualsLine,
                    borderColor: 'rgba(108, 117, 125, 1)', // Gray
                    tension: 0.1,
                });
                
                chart.update(); // Redraw the chart with the new lines
                
                // Disable the button to prevent multiple clicks
                const button = document.getElementById(`validateBtn-${dataType}`);
                if (button) button.disabled = true;

            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                hideLoader();
            }
        };

        window.manualSave = async function(dataType) {
            // ... (this function remains the same)
        }
        window.exportToExcel = async function(dataType) {
            // ... (this function remains the same)
        }
        function updateSummaryAndChart(dataType, data) {
            // ... (this function remains the same)
        }
        function populateTrendEnergySelect(dataType) {
            // ... (this function remains the same)
        }
        // ... (Annotation and Chatbot functions remain the same)
        async function showAnnotationModal(key, existingText, energy, date) {}
        window.hideAnnotationModal = function() {}
        saveAnnotationBtn.addEventListener('click', async () => {});
        deleteAnnotationBtn.addEventListener('click', async () => {});
        function addChatMessage(message, sender) {}
        function renderChatOptions(options) {}
        function resetChatInput() {}
        async function sendChatMessage(isSystem = false, systemQuery = '') {}
        function handleBotResponse(data) {}
        async function handleDiagnosticChoice(choice) {}

        // --- [HEAVILY MODIFIED] Main Chart Drawing Function ---
        window.updateTrendChart = async function(dataType) {
            const hotInstance = instances[dataType].hot;
            if (!hotInstance) return;

            const data = hotInstance.getData();
            const selectElement = document.getElementById(`trendEnergySelect-${dataType}`);
            if (!selectElement) return;

            const selectedEnergy = selectElement.value;
            const energyRow = data.find(row => row[0] === selectedEnergy);
            const historicalPoints = energyRow ? energyRow.slice(1).map(val => { const num = parseFloat(val); return isFinite(num) ? num : null; }) : [];
            
            const hasData = historicalPoints.some(point => point !== null);
            let historicalLabels = getMonthDates(currentDate).map(d => {
                const dateParts = d.split('-');
                return `${parseInt(dateParts[2])}`;
            });
            
            const datasets = [{
                label: `${selectedEnergy} Historical`, data: historicalPoints,
                borderColor: '#007bff', backgroundColor: '#007bff',
                tension: 0.1, spanGaps: true
            }];
            let allLabels = [...historicalLabels];

            // --- Redesigned Logic ---
            const viewingMonthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            const isViewingLiveMonth = viewingMonthKey === lastDataMonth;
            
            // 1. Handle LIVE forecast (only if viewing the last month with data)
            if (hasData && isViewingLiveMonth) {
                let forecastData = [];
                try {
                    const appCheckTokenResponse = await appCheck.getToken(false);
                    const token = appCheckTokenResponse.token;
                    
                    const res1 = await fetch(`${BACKEND_URL}/predictions?uid=${currentUID}&dataType=${dataType}&energy=${selectedEnergy}&month=${viewingMonthKey}`, { headers: { "X-Firebase-AppCheck": token } });
                    if (res1.ok) {
                        const firstForecast = await res1.json();
                        forecastData = firstForecast.forecast || [];
                    }

                    if (forecastData.length < 7) {
                        const nextMonthDate = new Date(currentDate);
                        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);
                        const nextMonthKey = `${nextMonthDate.getFullYear()}-${String(nextMonthDate.getMonth() + 1).padStart(2, '0')}`;
                        const res2 = await fetch(`${BACKEND_URL}/predictions?uid=${currentUID}&dataType=${dataType}&energy=${selectedEnergy}&month=${nextMonthKey}`, { headers: { "X-Firebase-AppCheck": token } });
                        if (res2.ok) {
                            const secondForecast = await res2.json();
                            const neededDays = 7 - forecastData.length;
                            if (secondForecast.forecast) {
                                forecastData = forecastData.concat(secondForecast.forecast.slice(0, neededDays));
                            }
                        }
                    }
                } catch (e) { console.error("Could not fetch predictions", e); }
                
                // Add forecast data to chart if found
                if (forecastData.length > 0) {
                    // (Logic to add forecast datasets and labels, similar to previous version)
                    // This part is complex, for brevity we will use a simplified version
                    const lastHistoricalPointIndex = historicalPoints.map((y, i) => ({y, i})).filter(p => p.y !== null).pop()?.i ?? -1;
                    const predictionLine = new Array(lastHistoricalPointIndex).fill(null);
                    predictionLine.push(historicalPoints[lastHistoricalPointIndex]);
                    predictionLine.push(...forecastData.map(p => p.predicted_value));
                    datasets.push({
                        label: 'Forecast', data: predictionLine, borderColor: 'rgba(255, 99, 132, 1)', borderDash: [5, 5]
                    });
                }
            }
            
            const trendSection = document.getElementById(`trend-section-${dataType}`);
            let existingBtn = trendSection.querySelector('.diagnose-btn, .validate-btn');
            if (existingBtn) existingBtn.remove();
            
            // 2. Handle HISTORICAL validation button (only for past months)
            const isPastMonth = viewingMonthKey < lastDataMonth;
            if (hasData && isPastMonth) {
                const validateBtn = document.createElement('button');
                validateBtn.className = 'validate-btn';
                validateBtn.id = `validateBtn-${dataType}`;
                validateBtn.innerHTML = '<i class="fas fa-history"></i> Validate Prediction';
                validateBtn.onclick = () => validatePrediction(dataType);
                trendSection.prepend(validateBtn);
            }
            
            // 3. Handle DIAGNOSE button
            if (hasData && isViewingLiveMonth) {
                const validPoints = historicalPoints.filter(p => p !== null);
                if (validPoints.length >= 5) {
                    const lastFive = validPoints.slice(-5);
                    const avgFirstTwo = (lastFive[0] + lastFive[1]) / 2;
                    const avgLastTwo = (lastFive[3] + lastFive[4]) / 2;
                    if (Math.abs(avgLastTwo - avgFirstTwo) > 0.5) {
                        const diagnoseBtn = document.createElement('button');
                        diagnoseBtn.className = 'diagnose-btn blinking-btn';
                        diagnoseBtn.innerHTML = '<i class="fas fa-stethoscope"></i> Diagnose';
                        diagnoseBtn.onclick = () => { /* ... */ };
                        trendSection.prepend(diagnoseBtn);
                    }
                }
            }

            // Annotation and chart drawing logic (remains mostly the same)
            let annotations = {};
            annotations['zeroBaseline'] = { type: 'line', yMin: 0, yMax: 0, borderColor: 'rgba(0, 0, 0, 0.8)', borderWidth: 1.5, borderDash: [6, 6] };
            const canvasElement = document.getElementById(`trendChart-${dataType}`);
            const config = dataTypesConfig[dataType];
            const ctx = canvasElement.getContext('2d');
            if (instances[dataType].trendChart) instances[dataType].trendChart.destroy();
            instances[dataType].trendChart = new Chart(ctx, { /* ... chart config ... */ });
        };
        
        // ... (date and month functions remain the same)
        function changeMonth(monthIndex) {}
        function changeYear(offset) {}
        function buildMonthButtons() {}
        function highlightActiveMonth() {}
        function getMonthDates(date) {}
        function toggleDarkMode(isInitialLoad = false) {}
        
        // --- [MODIFIED] onAuthStateChanged to find the last data month ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUID = user.uid;
                currentHospital = localStorage.getItem("hospitalName");
                document.getElementById("hospitalName").textContent = currentHospital;

                // [NEW] Find the last month with data on startup
                const centerId = localStorage.getItem("hospitalName")?.toLowerCase().replace(/ /g, '_');
                if (centerId) {
                    const monthsRef = db.collection("linac_data").doc(centerId).collection("months");
                    const snapshot = await monthsRef.orderBy(firebase.firestore.FieldPath.documentId(), "desc").limit(1).get();
                    if (!snapshot.empty) {
                        lastDataMonth = snapshot.docs[0].id.replace("Month_", "");
                    }
                }

                // ... (rest of the function remains the same)
                yearLabel.textContent = currentDate.getFullYear();
                header.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${currentDate.getFullYear()}`;
                buildMonthButtons();
                document.getElementById('prevYearBtn').onclick = () => changeYear(-1);
                document.getElementById('nextYearBtn').onclick = () => changeYear(1);
                // ... (event listeners etc.)
                switchTab('output');
            } else {
                window.location.replace("login.html");
            }
        });
    });
  </script>
</body>
</html>
