<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>LINAC Output Entry</title>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.0.0/dist/handsontable.full.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    .container { display: flex; justify-content: space-between; align-items: flex-start; }
    .summary-box { background: #f9f9f9; padding: 20px; border-radius: 8px; width: 400px; }
    .summary-box h3 { margin-top: 0; }
    .month-nav { margin-bottom: 10px; }
    .month-nav button { padding: 5px 10px; }
    #table { width: 100%; overflow-x: auto; }
  </style>
</head>
<body>
  <h2>LINAC Output Entry</h2>
  <div class="month-nav">
    <button onclick="prevMonth()">← Previous</button>
    <span id="month-label" style="margin: 0 10px;"></span>
    <button onclick="nextMonth()">Next →</button>
  </div>

  <div class="container">
    <div id="table"></div>
    <div class="summary-box">
      <canvas id="summaryChart" width="300" height="300"></canvas>
      <h3>Summary</h3>
      <p><strong>Total Entries:</strong> <span id="total">0</span></p>
      <p style="color:green;"><strong>✔</strong> Within Tolerance: <span id="within">0</span></p>
      <p style="color:orange;"><strong>⚠</strong> Warning: <span id="warning">0</span></p>
      <p style="color:red;"><strong>✘</strong> Out of Tolerance: <span id="out">0</span></p>
    </div>
  </div>

  <script>
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    const tolerance = 2.0;
    let hot;

    function renderTable(year, month) {
      document.getElementById("month-label").innerText = `${new Date(year, month).toLocaleString('default', { month: 'long' })} ${year}`;
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const energies = ["6X", "10X", "15X", "6X FFF", "10X FFF", "6E", "9E", "12E", "15E", "18E"];
      const data = energies.map(e => [e, ...Array(daysInMonth).fill("")]);

      const colHeaders = ["Energy"];
      for (let d = 1; d <= daysInMonth; d++) {
        colHeaders.push(new Date(year, month, d).toISOString().split("T")[0]);
      }

      const container = document.getElementById("table");
      container.innerHTML = ""; // clear previous

      hot = new Handsontable(container, {
        data,
        rowHeaders: false,
        colHeaders: colHeaders,
        licenseKey: "non-commercial-and-evaluation",
        columns: [{ readOnly: true }, ...Array(daysInMonth).fill({})],
        stretchH: "all",
        height: 400,
        afterChange: updateSummary
      });

      updateSummary();
    }

    function updateSummary() {
      if (!hot) return;
      const data = hot.getData();
      let total = 0, within = 0, warning = 0, out = 0;

      data.forEach(row => {
        row.slice(1).forEach(cell => {
          const value = parseFloat(cell);
          if (!isNaN(value)) {
            total++;
            if (Math.abs(value) <= tolerance) {
              within++;
            } else if (Math.abs(value) <= tolerance + 1) {
              warning++;
            } else {
              out++;
            }
          }
        });
      });

      document.getElementById("total").textContent = total;
      document.getElementById("within").textContent = within;
      document.getElementById("warning").textContent = warning;
      document.getElementById("out").textContent = out;

      updateChart(within, warning, out);
    }

    let summaryChart;
    function updateChart(within, warning, out) {
      const ctx = document.getElementById("summaryChart").getContext("2d");
      if (summaryChart) summaryChart.destroy();
      summaryChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Within Tolerance", "Warning", "Out of Tolerance"],
          datasets: [{
            data: [within, warning, out],
            backgroundColor: ["#98FB98", "orange", "#FF6961"]
          }]
        }
      });
    }

    function prevMonth() {
      if (currentMonth === 0) {
        currentMonth = 11;
        currentYear--;
      } else {
        currentMonth--;
      }
      renderTable(currentYear, currentMonth);
    }

    function nextMonth() {
      if (currentMonth === 11) {
        currentMonth = 0;
        currentYear++;
      } else {
        currentMonth++;
      }
      renderTable(currentYear, currentMonth);
    }

    renderTable(currentYear, currentMonth);
  </script>
</body>
</html>
