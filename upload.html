<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload Output Variation Excel File</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        h2 {
            color: #333;
        }

        #resultsContainer {
            margin-top: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        thead {
            background-color: #f9f9f9;
        }

        .status-pass {
            color: green;
            font-weight: bold;
        }

        .status-warning {
            color: orange;
            font-weight: bold;
        }

        .status-fail {
            color: red;
            font-weight: bold;
        }

        #downloadBtn {
            margin-top: 15px;
            display: none;
        }
    </style>
</head>
<body>

    <h2>Upload Output Variation Excel File</h2>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">Upload</button>
    <button id="downloadBtn" onclick="downloadCSV()">Download CSV</button>

    <div id="resultsContainer">
        <h3>Evaluation Results:</h3>
    </div>

    <script>
        let latestResults = [];

        function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const resultsContainer = document.getElementById("resultsContainer");
            const downloadBtn = document.getElementById("downloadBtn");

            if (!fileInput.files.length) {
                alert("Please choose a file first.");
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append("file", file);

            fetch("https://back-end-wrxi.onrender.com/upload", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    latestResults = data.results;
                    let tableHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Variation</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    data.results.forEach(result => {
                        const statusClass = "status-" + result.Status.toLowerCase();
                        tableHTML += `
                            <tr>
                                <td>${result.Date}</td>
                                <td>${result.Variation}%</td>
                                <td class="${statusClass}">${result.Status}</td>
                            </tr>
                        `;
                    });

                    tableHTML += "</tbody></table>";
                    resultsContainer.innerHTML = "<h3>Evaluation Results:</h3>" + tableHTML;
                    downloadBtn.style.display = "inline-block";
                } else {
                    resultsContainer.innerHTML = "<h3>Evaluation Results:</h3><p>No results found.</p>";
                    downloadBtn.style.display = "none";
                }
            })
            .catch(error => {
                console.error("Error uploading file:", error);
                resultsContainer.innerHTML = "<p style='color: red;'>Error processing the file.</p>";
                downloadBtn.style.display = "none";
            });
        }

        function downloadCSV() {
            if (latestResults.length === 0) return;

            const headers = ["Date", "Variation", "Status"];
            const rows = latestResults.map(r => [r.Date, r.Variation + "%", r.Status]);

            let csvContent = "data:text/csv;charset=utf-8," 
                           + [headers, ...rows].map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "evaluation_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

</body>
</html>
