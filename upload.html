<script>
  const energies = ['6X', '10X', '15X', '6X FFF', '10X FFF', '6E', '9E', '12E', '15E', '18E'];
  const tolerance = 2;
  const warningRange = 0.1;

  let currentMonthIndex = 2;
  const year = 2025;
  const monthNames = ["January", "February", "March", "April", "May", "June",
                      "July", "August", "September", "October", "November", "December"];

  const container = document.getElementById('hot');
  let hot = null;
  let summaryChart = null;
  const monthlyData = {};

  function getMonthKey() {
    return `${year}-${String(currentMonthIndex + 1).padStart(2, '0')}`;
  }

  function generateHeaders(monthIndex) {
    const days = new Date(year, monthIndex + 1, 0).getDate();
    const headers = ['Energy'];
    for (let d = 1; d <= days; d++) {
      headers.push(`${d.toString().padStart(2, '0')}-${monthNames[monthIndex].slice(0, 3)}`);
    }
    return headers;
  }

  function updateSummary() {
    let pass = 0, warn = 0, fail = 0, total = 0;
    const data = hot.getData();

    for (let r = 0; r < data.length; r++) {
      for (let c = 1; c < data[r].length; c++) {
        const val = parseFloat(data[r][c]);
        if (!isNaN(val)) {
          total++;
          if (Math.abs(val) <= tolerance - warningRange) pass++;
          else if (Math.abs(val) <= tolerance) warn++;
          else fail++;
        }
      }
    }

    document.getElementById('passCount').innerText = pass;
    document.getElementById('failCount').innerText = fail;
    document.getElementById('warningCount').innerText = warn;
    document.getElementById('totalCount').innerText = total;

    const ctx = document.getElementById('summaryChart').getContext('2d');
    if (summaryChart) summaryChart.destroy();
    summaryChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Within Tolerance', 'Warning', 'Out of Tolerance'],
        datasets: [{
          data: [pass, warn, fail],
          backgroundColor: ['#8bc34a', '#ffeb3b', '#f44336']
        }]
      },
      options: { responsive: true, plugins: { legend: { position: 'top' } } }
    });
  }

  function saveToDatabase() {
    const data = hot.getData();
    const headers = hot.getColHeader();
    const payload = {
      month: monthNames[currentMonthIndex],
      year: year,
      headers: headers,
      rows: data
    };

    fetch("https://back-end-wrxi.onrender.com/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(result => {
      console.log("Auto-saved:", result.message);
    })
    .catch(err => {
      console.error("Auto-save failed:", err);
    });
  }

  function loadMonth(index) {
    const key = getMonthKey();
    const headers = generateHeaders(index);
    document.getElementById('monthTitle').innerText = `${monthNames[index]} ${year}`;

    fetch("https://back-end-wrxi.onrender.com/load", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ month: monthNames[index], year: year })
    })
    .then(res => res.json())
    .then(loaded => {
      const grid = energies.map(energy => {
        const row = [energy];
        const saved = loaded[energy] || {};
        for (let i = 0; i < headers.length - 1; i++) {
          const label = headers[i + 1];
          row.push(saved[label] ?? '');
        }
        return row;
      });

      monthlyData[key] = grid;

      if (hot) {
        hot.updateSettings({ data: grid, colHeaders: headers });
      } else {
        hot = new Handsontable(container, {
          data: grid,
          colHeaders: headers,
          rowHeaders: true,
          width: '100%',
          height: 400,
          licenseKey: 'non-commercial-and-evaluation',
          stretchH: 'all',
          afterChange: function (changes, source) {
            if (['edit', 'Autofill.fill', 'paste', 'CopyPaste.paste'].includes(source)) {
              updateSummary();
              saveToDatabase();  // ðŸš€ auto-save trigger
            }
          },
          afterPaste: function () {
            updateSummary();
            saveToDatabase();  // ðŸš€ auto-save trigger
          }
        });
      }

      updateSummary();
    })
    .catch(err => {
      console.error("Load error:", err);
      alert("Failed to load saved data for this month.");
    });
  }

  function prevMonth() {
    currentMonthIndex = (currentMonthIndex - 1 + 12) % 12;
    loadMonth(currentMonthIndex);
  }

  function nextMonth() {
    currentMonthIndex = (currentMonthIndex + 1) % 12;
    loadMonth(currentMonthIndex);
  }

  loadMonth(currentMonthIndex);
</script>
