<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictive Analysis Dashboard | LINAC QA</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- IMPORTANT: Add the Plotly.js library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <style>
        html, body {
            height: 100vh;
            overflow: hidden;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .main-content {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
            height: calc(100vh - 71px); /* Full height minus topbar */
        }
        .controls-panel {
            flex: 1;
            min-width: 350px;
            max-width: 400px;
        }
        .plot-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
        }
        .plot-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--bg-card);
            padding: 20px;
            min-height: 0;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div id="hospitalInfoBox" class="hospital-info-box">Hospital: <span id="hospitalName"></span></div>
        <div class="header-buttons">
             <a href="upload.html" class="button">Back to Data Entry</a>
            <button id="logoutBtn" title="Logout" aria-label="Logout" class="header-btn" style="background-color: var(--status-error); color: white;"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>
    <main class="main-content">
        <div class="controls-panel">
            <div class="card-section" style="height: 100%;">
                <h2>Predictive Analysis</h2>
                <p>Select a metric and energy to generate a forecast and identify anomalies.</p>
                <div class="form-group">
                    <label for="dataTypeSelect">Select QA Metric</label>
                    <select id="dataTypeSelect">
                        <option value="output">Output</option>
                        <option value="flatness">Flatness</option>
                        <option value="inline">Inline Symmetry</option>
                        <option value="crossline">Crossline Symmetry</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="energySelect">Select Energy</label>
                    <select id="energySelect">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>
        </div>
        <div class="plot-panel">
            <div class="plot-container" id="plotly-chart-container">
                <div id="chart-loader">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px;">Loading forecast, please wait...</p>
                </div>
            </div>
        </div>
    </main>
    
    <div id="loading-overlay"><div class="spinner"></div></div>

    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-check-compat.js"></script>
    <script src="firebase-init.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const auth = firebase.auth();
            const appCheck = firebase.appCheck();
            const BACKEND_URL = "https://back-end-wrxi.onrender.com";
            
            const dataTypeSelect = document.getElementById('dataTypeSelect');
            const energySelect = document.getElementById('energySelect');
            const plotContainer = document.getElementById('plotly-chart-container');
            const loader = document.getElementById('chart-loader');

            const energyTypes = ["6X", "10X", "15X", "6X FFF", "10X FFF", "6E", "9E", "12E", "15E", "18E"];

            function populateEnergyDropdown() {
                energySelect.innerHTML = '';
                energyTypes.forEach(energy => {
                    const option = document.createElement('option');
                    option.value = energy;
                    option.textContent = energy;
                    energySelect.appendChild(option);
                });
            }

            window.logout = function() {
                auth.signOut().then(() => {
                    localStorage.clear();
                    window.location.replace("login.html");
                });
            }

            async function updateForecastPlot() {
                const user = auth.currentUser;
                if (!user) return;

                const dataType = dataTypeSelect.value;
                const energy = energySelect.value;

                if (!dataType || !energy) return;

                loader.style.display = 'block';
                plotContainer.innerHTML = ''; 

                try {
                    const idToken = await user.getIdToken(true);
                    const appCheckToken = (await appCheck.getToken(false)).token;
                    
                    const response = await fetch(`${BACKEND_URL}/api/v1/forecast-plot?dataType=${dataType}&energy=${energy}`, {
                        headers: { 
                            'Authorization': `Bearer ${idToken}`,
                            'X-Firebase-AppCheck': appCheckToken
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to load plot data.');
                    }

                    // --- [THE FIX IS HERE] ---
                    // response.json() now directly gives us the correct object.
                    // The extra JSON.parse() is removed.
                    const figure = await response.json();
                    
                    Plotly.newPlot(plotContainer, figure.data, figure.layout, {responsive: true});

                } catch (error) {
                    console.error("Error rendering plot:", error);
                    plotContainer.innerHTML = `<div style="text-align:center; padding: 20px;"><h3>Forecast Unavailable</h3><p style="color:red;">${error.message}</p></div>`;
                } finally {
                    loader.style.display = 'none';
                }
            }
            
            dataTypeSelect.addEventListener('change', updateForecastPlot);
            energySelect.addEventListener('change', updateForecastPlot);

            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById("hospitalName").textContent = localStorage.getItem("hospitalName");
                    document.getElementById('logoutBtn').onclick = logout;
                    populateEnergyDropdown();
                    updateForecastPlot(); 
                } else {
                    window.location.replace("login.html");
                }
            });
        });
    </script>
</body>
</html>
